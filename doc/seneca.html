<!DOCTYPE html>

<html>
<head>
  <title>seneca.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>seneca.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/* Copyright (c) 2010-2014 Richard Rodger, MIT License */</span>
<span class="hljs-comment">/* jshint node:true, asi:true, eqnull:true */</span>
<span class="hljs-pi">"use strict"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Current version, access using <em>seneca.version</em> property</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> VERSION = <span class="hljs-string">'0.6.0'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Node API modules</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> util     = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>)
<span class="hljs-keyword">var</span> events   = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>)
<span class="hljs-keyword">var</span> net      = <span class="hljs-built_in">require</span>(<span class="hljs-string">'net'</span>)
<span class="hljs-keyword">var</span> repl     = <span class="hljs-built_in">require</span>(<span class="hljs-string">'repl'</span>)
<span class="hljs-keyword">var</span> path     = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)
<span class="hljs-keyword">var</span> buffer   = <span class="hljs-built_in">require</span>(<span class="hljs-string">'buffer'</span>)
<span class="hljs-keyword">var</span> assert   = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>External modules</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> _            = <span class="hljs-built_in">require</span>(<span class="hljs-string">'underscore'</span>)
<span class="hljs-keyword">var</span> async        = <span class="hljs-built_in">require</span>(<span class="hljs-string">'async'</span>)
<span class="hljs-keyword">var</span> minimist     = <span class="hljs-built_in">require</span>(<span class="hljs-string">'minimist'</span>)
<span class="hljs-keyword">var</span> nid          = <span class="hljs-built_in">require</span>(<span class="hljs-string">'nid'</span>)
<span class="hljs-keyword">var</span> jsonic       = <span class="hljs-built_in">require</span>(<span class="hljs-string">'jsonic'</span>)
<span class="hljs-keyword">var</span> patrun       = <span class="hljs-built_in">require</span>(<span class="hljs-string">'patrun'</span>)
<span class="hljs-keyword">var</span> parambulator = <span class="hljs-built_in">require</span>(<span class="hljs-string">'parambulator'</span>)
<span class="hljs-keyword">var</span> norma        = <span class="hljs-built_in">require</span>(<span class="hljs-string">'norma'</span>)
<span class="hljs-keyword">var</span> stats        = <span class="hljs-built_in">require</span>(<span class="hljs-string">'rolling-stats'</span>)
<span class="hljs-keyword">var</span> makeuse      = <span class="hljs-built_in">require</span>(<span class="hljs-string">'use-plugin'</span>)
<span class="hljs-keyword">var</span> lrucache     = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lru-cache'</span>)
<span class="hljs-keyword">var</span> zig          = <span class="hljs-built_in">require</span>(<span class="hljs-string">'zig'</span>)
<span class="hljs-keyword">var</span> gex          = <span class="hljs-built_in">require</span>(<span class="hljs-string">'gex'</span>)
<span class="hljs-keyword">var</span> executor     = <span class="hljs-built_in">require</span>(<span class="hljs-string">'gate-executor'</span>)
<span class="hljs-keyword">var</span> error        = <span class="hljs-built_in">require</span>(<span class="hljs-string">'eraro'</span>)({package:<span class="hljs-string">'seneca'</span>,msgmap:ERRMSGMAP()})</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Internal modules</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> make_entity  = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib/entity'</span>)
<span class="hljs-keyword">var</span> store        = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib/store'</span>)
<span class="hljs-keyword">var</span> logging      = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib/logging'</span>)
<span class="hljs-keyword">var</span> plugin_util  = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib/plugin-util'</span>)
<span class="hljs-keyword">var</span> makeoptioner = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib/optioner'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Utility functions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> common   = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib/common'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Abbreviations</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> arr = common.arrayify</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Exports.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">module</span>.exports = init</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Create a new Seneca instance.</p>
<ul>
<li>initial_options  &rarr;  options</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">make_seneca</span><span class="hljs-params">( initial_options )</span> </span>{
  <span class="hljs-comment">/* jshint validthis:true */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Create a private context.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> private$ = {
    stats: {
      start: <span class="hljs-built_in">Date</span>.now(),
      act: {
        calls: <span class="hljs-number">0</span>,
        done:  <span class="hljs-number">0</span>,
        fails: <span class="hljs-number">0</span>,
        cache: <span class="hljs-number">0</span>
      },
      actmap:{}
    }
  }


  initial_options = initial_options || {}</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Seneca is an EventEmitter.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Seneca</span><span class="hljs-params">()</span> </span>{
    events.EventEmitter.call(<span class="hljs-keyword">this</span>)
    <span class="hljs-keyword">this</span>.setMaxListeners(<span class="hljs-number">0</span>)
  }
  util.inherits(Seneca, events.EventEmitter)

  <span class="hljs-keyword">var</span> root = <span class="hljs-keyword">new</span> Seneca()

  root.context = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Expose the current version of Seneca</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  root.version = VERSION</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <h3 id="seneca-add">seneca.add</h3>
<p>Add an message pattern and action function.</p>
<p><code>seneca.add( pattern, action )</code>  </p>
<ul>
<li><em>pattern</em> (object or string)  &rarr;  pattern definition</li>
<li><em>action</em> (function)           &rarr;  function executed when input to <code>seneca.act</code> matches pattern</li>
</ul>
<p><code>seneca.add( pattern_string, pattern_object, action )</code>  </p>
<ul>
<li><em>pattern_string</em> (string)  &rarr;  pattern definition as jsonic string  </li>
<li><em>pattern_object</em> (object)  &rarr;  pattern definition as object  </li>
<li><em>action</em> (function)        &rarr;  function executed when input to <code>seneca.act</code> matches pattern.  </li>
</ul>
<p>The pattern is defined by the top level properties of the <em>pattern</em> parameter.
In the case where the pattern is a string, it is first parsed by <a href="https://github.com/rjrodger/jsonic">jsonic</a></p>
<p>If the value of a pattern property is a sub-object, this is interpreted as a 
<a href="https://github.com/rjrodger/parambulator">parambulator</a> validation check. In this case, the property
is not considered part of the pattern, but rather an argument to validate when <em>seneca.act</em> is called.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  root.add = api_add


  root.sub = api_sub


  root.logroute   = api_logroute
  root.register   = api_register
  root.depends    = api_depends
  root.export     = api_export

  root.make       = api_make
  root.make$      = api_make
  root.listen     = api_listen
  root.client     = api_client
  root.cluster    = api_cluster
  root.hasplugin  = api_hasplugin
  root.findplugin = api_findplugin
  root.pin        = api_pin

  root.has        = api_hasact
  root.hasact     = api_hasact

  root.actroutes  = api_actroutes
  root.list       = api_list
  root.act        = api_act
  root.act_if     = api_act_if
  root.wrap       = api_wrap
  root.close      = api_close
  root.ready      = api_ready
  root.use        = api_use
  root.seneca     = api_seneca
  root.fix        = api_fix
  root.delegate   = api_delegate

  root.options    = api_options


  root.findact       = api_findact
  root.findact.mark  = <span class="hljs-string">'top'</span>

  root.start = api_start


  <span class="hljs-keyword">var</span> paramcheck = {}

  paramcheck.options = parambulator({
    tag:        { string$:<span class="hljs-literal">true</span> },
    idlen:      { integer$:<span class="hljs-literal">true</span> },
    timeout:    { integer$:<span class="hljs-literal">true</span> },
    errhandler: { <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-title">$</span>:<span class="hljs-title">true</span> },
  },</span>{
    topname:       <span class="hljs-string">'options'</span>,
    msgprefix:     <span class="hljs-string">'seneca( {...} ): '</span>,
  })




  <span class="hljs-keyword">var</span> argv = minimist(process.argv.slice(<span class="hljs-number">2</span>))</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Resolve options.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> optioner = private$.optioner = 
        makeoptioner( 
          argv, 
          initial_options.module || <span class="hljs-built_in">module</span>.parent || <span class="hljs-built_in">module</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Default options.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          {
            tag:             <span class="hljs-string">'-'</span>,
            idlen:           <span class="hljs-number">12</span>,
            timeout:         <span class="hljs-number">33333</span>,
            status_interval: <span class="hljs-number">60000</span>,

            actcache:        <span class="hljs-literal">true</span>,
            actcache_size:   <span class="hljs-number">1111</span>,

            zig:{},

            trace:{
              act:   <span class="hljs-literal">false</span>,
              stack: <span class="hljs-literal">false</span>
            },

            stats: {
              size:     <span class="hljs-number">1024</span>,
              duration: <span class="hljs-number">60000</span>,
              running:  <span class="hljs-literal">false</span>
            },

            debug:{
              allargs: <span class="hljs-literal">false</span>,
              fragile: <span class="hljs-literal">false</span>,
              undead:  <span class="hljs-literal">false</span>,
            },

            deathdelay: <span class="hljs-number">33333</span>,

            test:{
              stayalive: <span class="hljs-literal">false</span>
            },

            admin:{
              local:  <span class="hljs-literal">false</span>,
              prefix: <span class="hljs-string">'/admin'</span>
            },

            plugin:{},

            internal: {
              actrouter:    patrun(),
              clientrouter: patrun(pin_patrun_customizer),
              subrouter:    patrun(pin_patrun_customizer)
            },

            default_plugins: {
              basic:       <span class="hljs-literal">true</span>, 
              <span class="hljs-string">'mem-store'</span>: <span class="hljs-literal">true</span>, 
              transport:   <span class="hljs-literal">true</span>, 
              web:         <span class="hljs-literal">true</span>, 
            }
          }
        )</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>not needed after this point, and screws up debug printing</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">delete</span> initial_options.module 

  <span class="hljs-keyword">var</span> so = optioner.set( initial_options )

  paramcheck.options.validate(so,thrower)</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Identifier generator.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  root.idgen = nid({length:so.idlen})</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Create a unique identifer for this instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  root.id = root.idgen()+<span class="hljs-string">'/'</span>+<span class="hljs-built_in">Date</span>.now()+<span class="hljs-string">'/'</span>+so.tag

  root.name = <span class="hljs-string">'Seneca/'</span>+root.version+<span class="hljs-string">'/'</span>+root.id


  root.die = makedie( root, {
    type:   <span class="hljs-string">'sys'</span>,
    plugin: <span class="hljs-string">'seneca'</span>,
    tag:    root.version,
    id:     root.id
  })</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Error events are fatal, unless you’re undead.  These are not the
same as action errors, these are unexpected internal issues.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>( !so.debug.undead ) {
    root.on(<span class="hljs-string">'error'</span>,root.die) 
  }


  private$.logrouter = logging.makelogrouter(so.log)

  root.log = logging.makelog(private$.logrouter,root.id)</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>TODO: support options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  private$.executor = executor({
    trace:   _.isFunction(so.trace.act) ? so.trace.act : 
      (!!so.trace.act) ? make_trace_act({stack:so.trace.stack}) : <span class="hljs-literal">false</span>,
    timeout: so.timeout,
    error: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> </span>{
      <span class="hljs-keyword">if</span>( !err ) <span class="hljs-keyword">return</span>;
      logging.log_exec_err( root, err )
    },
    msg_codes: {
      timeout:   <span class="hljs-string">'action-timeout'</span>,
      error:     <span class="hljs-string">'action-error'</span>,
      callback:  <span class="hljs-string">'action-callback'</span>,
      execute:   <span class="hljs-string">'action-execute'</span>,
      abandoned: <span class="hljs-string">'action-abandoned'</span>
    }
  })</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>TODO: encapsulate
setup status log</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>( <span class="hljs-number">0</span> &lt; so.status_interval &amp;&amp; so.status_log ) {
    private$.stats = private$.stats || {}
    setInterval(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> stats = {alive:(<span class="hljs-built_in">Date</span>.now()-private$.stats.start),act:private$.stats.act}
      root.log.info(<span class="hljs-string">'status'</span>,stats)
    },so.status_interval)
  }

  <span class="hljs-keyword">if</span>( so.stats ) {
    private$.timestats = <span class="hljs-keyword">new</span> stats.NamedStats( so.stats.size, so.stats.duration )

    <span class="hljs-keyword">if</span>( so.stats.running ) {
      setInterval(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        private$.timestats.calculate()
      }, so.stats.duration )
    }
  }


  private$.plugins      = {}
  private$.exports      = { options: common.deepextend({},so) }
  private$.plugin_order = { byname:[], byref:[] }
  private$.use          = makeuse({
    prefix:    <span class="hljs-string">'seneca-'</span>, 
    <span class="hljs-built_in">module</span>:    <span class="hljs-built_in">module</span>, 
    msgprefix: <span class="hljs-literal">false</span>,
    builtin:   <span class="hljs-string">''</span>
  })

  private$.actcache       = lrucache({max:so.actcache_size})
  private$.wait_for_ready = <span class="hljs-literal">false</span>

  private$.actrouter    = so.internal.actrouter
  private$.clientrouter = so.internal.clientrouter
  private$.subrouter    = so.internal.subrouter



  root.on(<span class="hljs-string">'newListener'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(eventname)</span> </span>{
    <span class="hljs-keyword">if</span>( <span class="hljs-string">'ready'</span> == eventname ) {
      <span class="hljs-keyword">if</span>( !private$.wait_for_ready ) {
        private$.wait_for_ready = <span class="hljs-literal">true</span>
        root.act(<span class="hljs-string">'role:seneca,ready:true,gate$:true'</span>)
      }
    }
  })


  root.toString = api_toString
   

  root.util = {
    deepextend: common.deepextend,
    recurse:    common.recurse,
    clean:      common.clean,
    copydata:   common.copydata,
    nil:        common.nil,
    argprops:   common.argprops,
    print:      common.print,

    router:     <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> patrun() },
    parsecanon: make_entity.parsecanon,
  }


  root.store = {
    init: store.init,
    cmds: store.cmds
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>say hello, printing identifier to log</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  root.log.info(<span class="hljs-string">'hello'</span>,root.toString())</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>dump options if debugging</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  root.log.debug('options',function() {
    return util.inspect(so,false,null).replace(/[\r\n]/g,' ')
  })


  function api_logroute(entry,handler) {
    if( 0 === arguments.length ) return private$.logrouter.toString()

    entry.handler = handler || entry.handler
    logging.makelogroute(entry,private$.logrouter)
  }



  paramcheck.register = parambulator({
    type$:     'object',
    required$: ['name','init'],
    string$:   ['name'],
    function$: ['init','service'],
    object$:   ['options']
  },{
    topname:       'plugin',
    msgprefix:     'register(plugin): ',
  })



  function api_register( plugin ) {
    var self = this

    paramcheck.register.validate(plugin,thrower)

    var fullname = plugin.name+(plugin.tag?'/'+plugin.tag:'')
    var tag      = plugin.tag||'-'

    plugin.fullname = fullname
    var sd = plugin_util.make_delegate( 
      self, 
      plugin,</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>{makefail:makefail, makedie:makedie}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      {makedie:makedie}
    )

    self.log.debug(<span class="hljs-string">'register'</span>,<span class="hljs-string">'init'</span>,fullname)
    
    <span class="hljs-keyword">var</span> plugin_options = plugin_util.resolve_options(fullname,plugin,so)

    sd.log.debug(<span class="hljs-string">'DEFINE'</span>,plugin_options)

    <span class="hljs-keyword">var</span> meta = plugin_util.define_plugin( sd, plugin, plugin_options )</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>legacy api for service function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>( _.isFunction(meta) ) {
      meta = {service:meta}
    }

    plugin.name    = meta.name    || plugin.name
    plugin.tag     = meta.tag     || plugin.tag || 
      (plugin.options &amp;&amp; plugin.options.tag$)
    plugin.service = meta.service || plugin.service

    <span class="hljs-keyword">var</span> pluginref = plugin.name+(plugin.tag?<span class="hljs-string">'/'</span>+plugin.tag:<span class="hljs-string">''</span>)
    private$.plugins[pluginref] = plugin

    private$.plugin_order.byname.push(plugin.name)
    private$.plugin_order.byname = _.uniq(private$.plugin_order.byname)

    private$.plugin_order.byref.push(pluginref)</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>LEGACY</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> service = plugin.service
    <span class="hljs-keyword">if</span>( service ) {
      service.log = sd.log
      service.key = pluginref
      self.act(<span class="hljs-string">'role:web'</span>,{use:service})
    }

    self.act(
      {
        init:plugin.name,
        tag:plugin.tag,
        <span class="hljs-keyword">default</span>$:{},
        gate$:<span class="hljs-literal">true</span>
      },
      <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err,out)</span> </span>{
        <span class="hljs-keyword">if</span>( err ) {
          <span class="hljs-keyword">var</span> plugin_err_code = <span class="hljs-string">'plugin_init'</span>

          plugin.plugin_error = err.message

          <span class="hljs-keyword">if</span>( <span class="hljs-string">'action-timeout'</span> == err.code ) {
            plugin_err_code = <span class="hljs-string">'plugin_init_timeout'</span>
            plugin.timeout = so.timeout
          }

          <span class="hljs-keyword">return</span> self.die(plugin_err_code,err,plugin)
        }
        <span class="hljs-keyword">return</span> self.log.debug(<span class="hljs-string">'register'</span>,<span class="hljs-string">'ready'</span>,pluginref,out)
      }
    )

    <span class="hljs-keyword">var</span> exports = []
    
    <span class="hljs-keyword">if</span>( <span class="hljs-keyword">void</span> <span class="hljs-number">0</span> != meta.export ) {
      private$.exports[pluginref] = meta.export
      exports.push(pluginref)
    }

    <span class="hljs-keyword">if</span>( _.isObject(meta.exportmap) || _.isObject(meta.exports) ) {
      meta.exportmap = meta.exportmap || meta.exports
      _.each(meta.exportmap,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v,k)</span> </span>{
        <span class="hljs-keyword">if</span>( <span class="hljs-keyword">void</span> <span class="hljs-number">0</span> != v ) {
          <span class="hljs-keyword">var</span> exportname = pluginref+<span class="hljs-string">'/'</span>+k
          private$.exports[exportname] = v
          exports.push(exportname)
        }
      })
    }

    self.log.debug(<span class="hljs-string">'register'</span>,<span class="hljs-string">'install'</span>,pluginref,
                   {exports:exports},fullname!=pluginref?fullname:<span class="hljs-literal">undefined</span>)
  }


  
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_depends</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">var</span> args = norma(<span class="hljs-string">'{pluginname:s deps:a? moredeps:s*}'</span>,<span class="hljs-built_in">arguments</span>)
    
    <span class="hljs-keyword">var</span> deps = args.deps || args.moredeps

    _.every(deps, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(depname)</span> </span>{
      <span class="hljs-keyword">if</span>( !_.contains(private$.plugin_order.byname,depname) &amp;&amp;
          !_.contains(private$.plugin_order.byname,<span class="hljs-string">'seneca-'</span>+depname) ) {
        self.die(<span class="hljs-string">'plugin_required'</span>,{name:args.pluginname,dependency:depname})
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    })
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_export</span><span class="hljs-params">( key )</span> </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">var</span> exportval = private$.exports[key];
    <span class="hljs-keyword">if</span>( !exportval ) {
      <span class="hljs-keyword">return</span> self.die( <span class="hljs-string">'export_not_found'</span>, {key:key} )
    }
    
    <span class="hljs-keyword">return</span> exportval;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>all optional</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_make</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> args = arr(<span class="hljs-built_in">arguments</span>)
    args.unshift(self)
    <span class="hljs-keyword">return</span> private$.entity.make$.apply(private$.entity,args)
  }
  root.make$ = root.make




  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_listen</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">var</span> opts   = self.options().transport || {}
    <span class="hljs-keyword">var</span> config = parseConfig( arr(<span class="hljs-built_in">arguments</span>), opts )

    self.act(<span class="hljs-string">'role:transport,cmd:listen'</span>,{config:config,gate$:<span class="hljs-literal">true</span>},<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> </span>{
      <span class="hljs-keyword">if</span>( err ) <span class="hljs-keyword">return</span> self.die(<span class="hljs-string">'transport_listen'</span>,err,config)
    })

    <span class="hljs-keyword">return</span> self
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_client</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">var</span> opts   = self.options().transport || {}
    <span class="hljs-keyword">var</span> config = parseConfig( arr(<span class="hljs-built_in">arguments</span>), opts )</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Queue messages while waiting for client to become active.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> sendqueue = []
    <span class="hljs-keyword">var</span> sendclient = {
      send: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( args, done )</span> </span>{
        <span class="hljs-keyword">var</span> tosend = {instance:<span class="hljs-keyword">this</span>, args:args, done:done }
        self.log.debug(<span class="hljs-string">'client'</span>,<span class="hljs-string">'sendqueue-add'</span>,sendqueue.length+<span class="hljs-number">1</span>,config,tosend)
        sendqueue.push( tosend )
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>TODO: validate pin, pins args</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">var</span> pins = config.pins || [config.pin] || [<span class="hljs-string">''</span>]

    pins = _.map(pins, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(pin)</span></span>{
      <span class="hljs-keyword">return</span> _.isString(pin) ? jsonic(pin) : pin
    })


    _.each(pins,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(pin)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Only wrap if pin is specific.
Don’t want to wrap all patterns, esp. system ones!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>( <span class="hljs-number">0</span> &lt; _.keys(pin).length ) {
        self.wrap(pin,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(args,done)</span></span>{
          sendclient.send.call( <span class="hljs-keyword">this</span>, args, done ) 
        })
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>For patterns not locally defined.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      private$.clientrouter.add( 
        pin,
        {
          func: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(args,done)</span> </span>{ 
            sendclient.send.call( <span class="hljs-keyword">this</span>, args, done ) 
          },
          log:        self.log,
          argpattern: common.argpattern(pin),
          id:         <span class="hljs-string">'CLIENT'</span>,
          client$:    <span class="hljs-literal">true</span>
        })
    })</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Create client.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    self.act( 
      <span class="hljs-string">'role:transport,cmd:client'</span>,
      {config:config,gate$:<span class="hljs-literal">true</span>},
      <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err,liveclient)</span> </span>{
        <span class="hljs-keyword">if</span>( err ) <span class="hljs-keyword">return</span> self.die(<span class="hljs-string">'transport_client'</span>,err,config)
        <span class="hljs-keyword">if</span>( <span class="hljs-literal">null</span> == liveclient ) <span class="hljs-keyword">return</span> self.die(<span class="hljs-string">'transport_client_null'</span>,config)</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Process any messages waiting for this client, before bringing client online.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sendnext</span><span class="hljs-params">()</span> </span>{
          <span class="hljs-keyword">if</span>( <span class="hljs-number">0</span> === sendqueue.length ) {
            sendclient = liveclient
            self.log.debug(<span class="hljs-string">'client'</span>,<span class="hljs-string">'sendqueue-clear'</span>,config)
          }
          <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">var</span> tosend = sendqueue.shift()
            self.log.debug(<span class="hljs-string">'client'</span>,<span class="hljs-string">'sendqueue-processing'</span>,sendqueue.length+<span class="hljs-number">1</span>,config,tosend)
            sendclient.send.call(tosend.instance,tosend.args,tosend.done)
            setImmediate(sendnext)
          }
        }
        sendnext()
      })    
    
    <span class="hljs-keyword">return</span> self;
  }


  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseConfig</span><span class="hljs-params">( args, options )</span> </span>{
    <span class="hljs-keyword">var</span> out = {}

    <span class="hljs-keyword">var</span> config = args.config || args

    <span class="hljs-keyword">if</span>( _.isArray( config ) ) {
      <span class="hljs-keyword">var</span> arglen = config.length

      <span class="hljs-keyword">if</span>( <span class="hljs-number">1</span> === arglen ) {
        <span class="hljs-keyword">if</span>( _.isObject( config[<span class="hljs-number">0</span>] ) ) {
          out = config[<span class="hljs-number">0</span>]
        }
        <span class="hljs-keyword">else</span> {
          out.port = <span class="hljs-built_in">parseInt</span>(config[<span class="hljs-number">0</span>],<span class="hljs-number">10</span>)
        }
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( <span class="hljs-number">2</span> === arglen ) {
        out.port = <span class="hljs-built_in">parseInt</span>(config[<span class="hljs-number">0</span>],<span class="hljs-number">10</span>)
        out.host = config[<span class="hljs-number">1</span>]
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( <span class="hljs-number">3</span> === arglen ) {
        out.port = <span class="hljs-built_in">parseInt</span>(config[<span class="hljs-number">0</span>],<span class="hljs-number">10</span>)
        out.host = config[<span class="hljs-number">1</span>]
        out.path = config[<span class="hljs-number">2</span>]
      }

    }</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>TODO: accept a jsonic string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">else</span> out = config;

    
    _.each( options, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v,k)</span></span>{
      <span class="hljs-keyword">if</span>( _.isObject(v) ) <span class="hljs-keyword">return</span>;
      out[k] =  ( <span class="hljs-keyword">void</span> <span class="hljs-number">0</span> === out[k] ? v : out[k] )
    })</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Default transport is web</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    out.type = out.type || <span class="hljs-string">'web'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Aliases.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>( <span class="hljs-string">'direct'</span> == out.type || <span class="hljs-string">'http'</span> == out.type ) {
      out.type = <span class="hljs-string">'web'</span>
    }

    <span class="hljs-keyword">var</span> base = options[out.type] || {}

    out = _.extend({},base,out)

    <span class="hljs-keyword">if</span>( <span class="hljs-string">'web'</span> == out.type || <span class="hljs-string">'tcp'</span> == out.type ) {
      out.port = <span class="hljs-literal">null</span> == out.port ? base.port : out.port 
      out.host = <span class="hljs-literal">null</span> == out.host ? base.host : out.host
      out.path = <span class="hljs-literal">null</span> == out.path ? base.path : out.path
    }

    <span class="hljs-keyword">return</span> out
  }


  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_cluster</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">/* jshint loopfunc:true */</span>
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">var</span> cluster = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cluster'</span>)

    <span class="hljs-keyword">if</span>( cluster.isMaster ) {
      <span class="hljs-built_in">require</span>(<span class="hljs-string">'os'</span>).cpus().forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        cluster.fork()
      })

      cluster.on(<span class="hljs-string">'disconnect'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(worker)</span> </span>{
        cluster.fork()
      })

      <span class="hljs-keyword">var</span> noopinstance = self.delegate()
      <span class="hljs-keyword">for</span>( <span class="hljs-keyword">var</span> fn <span class="hljs-keyword">in</span> noopinstance ) {
        <span class="hljs-keyword">if</span>( _.isFunction(noopinstance[fn]) ) {
          noopinstance[fn] = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> noopinstance; }
        }
      }

      <span class="hljs-keyword">return</span> noopinstance;
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> self;
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_hasplugin</span><span class="hljs-params">(plugindesc,tag)</span> </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
    tag = (<span class="hljs-string">''</span> === tag || <span class="hljs-string">'-'</span> === tag) ? <span class="hljs-literal">null</span> : tag
    <span class="hljs-keyword">return</span> !!self.findplugin(plugindesc,tag)
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>get plugin instance</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_findplugin</span><span class="hljs-params">(plugindesc,tag)</span> </span>{
    <span class="hljs-keyword">var</span> name = plugindesc.name || plugindesc
    tag = plugindesc.tag || tag

    <span class="hljs-keyword">var</span> key = name+(tag?<span class="hljs-string">'/'</span>+tag:<span class="hljs-string">''</span>)
    <span class="hljs-keyword">var</span> plugin = private$.plugins[key]

    <span class="hljs-keyword">return</span> plugin
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_pin</span><span class="hljs-params">( pattern, pinopts )</span> </span>{
    <span class="hljs-keyword">var</span> thispin = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">var</span> methodkeys = []
    <span class="hljs-keyword">for</span>( <span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> pattern ) {
      <span class="hljs-keyword">if</span>( <span class="hljs-regexp">/[\*\?]/</span>.exec(pattern[key]) ) {
        methodkeys.push(key)
      }
    }


    <span class="hljs-keyword">var</span> methods = private$.actrouter.list(pattern)


    <span class="hljs-keyword">var</span> api = {
      toString: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">'pin:'</span>+common.descdata(pattern,<span class="hljs-number">1</span>)+<span class="hljs-string">'/'</span>+thispin
      }
    }


    methods.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(method)</span> </span>{
      <span class="hljs-keyword">var</span> mpat = method.match

      <span class="hljs-keyword">var</span> methodname = <span class="hljs-string">''</span>
      <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> mkI = <span class="hljs-number">0</span>; mkI &lt; methodkeys.length; mkI++) {
        methodname += ((<span class="hljs-number">0</span>&lt;mkI?<span class="hljs-string">'_'</span>:<span class="hljs-string">''</span>)) + mpat[methodkeys[mkI]]
      }

      api[methodname] = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(args,cb)</span> </span>{
        <span class="hljs-keyword">var</span> si = <span class="hljs-keyword">this</span> &amp;&amp; <span class="hljs-keyword">this</span>.seneca ? <span class="hljs-keyword">this</span> : thispin

        <span class="hljs-keyword">var</span> fullargs = _.extend({},args,mpat)
        si.act.call(si,fullargs,cb)
      }

      api[methodname].pattern$ = method.match
      api[methodname].name$    = methodname
    })

    <span class="hljs-keyword">if</span>( pinopts ) {
      <span class="hljs-keyword">if</span>( pinopts.include ) {
        <span class="hljs-keyword">for</span>( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; pinopts.include.length; i++ ) {
          <span class="hljs-keyword">var</span> methodname = pinopts.include[i]
          <span class="hljs-keyword">if</span>( thispin[methodname] ) {
            api[methodname] = common.delegate(thispin,thispin[methodname])
          }
        }
      }
    }

    <span class="hljs-keyword">return</span> api
  }


  <span class="hljs-keyword">var</span> pm_custom_args = {
    rules: {
      entity$: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(ctxt,cb)</span> </span>{
        <span class="hljs-keyword">var</span> val = ctxt.point
        <span class="hljs-keyword">if</span>( val.entity$ ) {
          <span class="hljs-keyword">if</span>( val.canon$({isa:ctxt.rule.spec}) ) {
            <span class="hljs-keyword">return</span> cb();
          }
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> ctxt.util.fail(ctxt,cb);
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> ctxt.util.fail(ctxt,cb);
      }
    },
    msgs: {
      entity$: <span class="hljs-string">'The value &lt;%=value%&gt; is not a data entity of kind &lt;%=rule.spec%&gt; (property &lt;%=parentpath%&gt;).'</span>
    }
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_sub</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">var</span> subargs = parse_pattern(self,<span class="hljs-built_in">arguments</span>,<span class="hljs-string">'action:f actmeta:o?'</span>)
    <span class="hljs-keyword">var</span> pattern = subargs.pattern
    <span class="hljs-keyword">if</span>( <span class="hljs-literal">null</span> == pattern.in$ &amp;&amp; 
        <span class="hljs-literal">null</span> == pattern.out$ &amp;&amp; 
        <span class="hljs-literal">null</span> == pattern.error$ &amp;&amp;
        <span class="hljs-literal">null</span> == pattern.cache$ &amp;&amp;
        <span class="hljs-literal">null</span> == pattern.default$ &amp;&amp;
        <span class="hljs-literal">null</span> == pattern.client$ ) 
    {
      pattern.in$ = <span class="hljs-literal">true</span>
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>console.log(pattern)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">if</span>( !private$.handle_sub ) {
      private$.handle_sub = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(args,result)</span> </span>{
        <span class="hljs-keyword">var</span> subfuncs = private$.subrouter.find(args)</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>console.log(‘F’,args,’’+subfuncs)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span>( subfuncs ) {
          _.each(subfuncs,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(subfunc)</span></span>{
            <span class="hljs-keyword">try</span> {
              subfunc.call(self,args,result)
            }
            <span class="hljs-keyword">catch</span>(ex) {</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>TODO: not really satisfactory
var err = self.fail( error, {args:args,result:result} )</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">var</span> err = error(ex,<span class="hljs-string">'sub_function_catch'</span>,{args:args,result:result})
              self.log.error(
                <span class="hljs-string">'sub'</span>,<span class="hljs-string">'err'</span>,args.actid$, err.message, args, error.stack )
            }
          })
        }
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>TODO: other cases</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
      self.on(<span class="hljs-string">'act-in'</span>,  annotate( <span class="hljs-string">'in$'</span>,  private$.handle_sub))
      self.on(<span class="hljs-string">'act-out'</span>, annotate( <span class="hljs-string">'out$'</span>, private$.handle_sub))
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">annotate</span><span class="hljs-params">( prop, handle_sub )</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( args,result )</span> </span>{
        args   = _.clone(args)
        result = _.clone(result)
        args[prop] = <span class="hljs-literal">true</span>
        handle_sub(args,result)
      }
    }

    <span class="hljs-keyword">var</span> subs = private$.subrouter.find(pattern)
    <span class="hljs-keyword">if</span>( !subs ) {
      private$.subrouter.add(pattern,subs=[])
    }
    subs.push(subargs.action)</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>console.log(private$.subrouter)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">return</span> self;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>params: argstr,argobj,actfunc,actmeta</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_add</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> args = parse_pattern(self,<span class="hljs-built_in">arguments</span>,<span class="hljs-string">'action:f actmeta:o?'</span>)

    <span class="hljs-keyword">var</span> pattern   = args.pattern
    <span class="hljs-keyword">var</span> action    = args.action
    <span class="hljs-keyword">var</span> actmeta   = args.actmeta || {}

    actmeta.sub = !!pattern.sub$

    pattern = self.util.clean(args.pattern)

    <span class="hljs-keyword">if</span>( <span class="hljs-number">0</span> === _.keys( pattern ) ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>throw self.fail(‘add_empty_pattern’,{args:args})</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">throw</span> error(<span class="hljs-string">'add_empty_pattern'</span>,{args:args})
    }


    <span class="hljs-keyword">var</span> pattern_rules = {}
    _.each( pattern, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v,k)</span> </span>{ 
      <span class="hljs-keyword">if</span>( _.isObject(v) ) {
        pattern_rules[k] = v
        <span class="hljs-keyword">delete</span> pattern[k]
      }
    })
    
    <span class="hljs-keyword">if</span>( <span class="hljs-number">0</span> &lt; _.keys(pattern_rules).length ) {
      actmeta.parambulator = parambulator(pattern_rules, pm_custom_args)
    }

    <span class="hljs-keyword">var</span> addroute  = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">var</span> priormeta = self.findact( pattern )

    actmeta.args = _.clone( pattern )
    actmeta.pattern = common.argpattern( pattern )</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>deprecated</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    actmeta.argpattern = actmeta.pattern

    actmeta.id = self.idgen()



    actmeta.func = action

    <span class="hljs-keyword">if</span>( priormeta ) {
      <span class="hljs-keyword">if</span>( _.isFunction(priormeta.handle) ) {
        priormeta.handle(action)
        addroute = <span class="hljs-literal">false</span>
      }
      <span class="hljs-keyword">else</span> { 
        actmeta.priormeta = priormeta 
      }
      actmeta.priorpath = priormeta.id+<span class="hljs-string">';'</span>+priormeta.priorpath
    }
    <span class="hljs-keyword">else</span> {
      actmeta.priorpath = <span class="hljs-string">''</span>
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>FIX: need a much better way to support layered actions
this “.handle” hack is just to make seneca.close work</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>( action &amp;&amp; actmeta &amp;&amp; _.isFunction(action.handle) ) {
      actmeta.handle = action.handle
    }


    private$.stats.actmap[actmeta.argpattern] = 
      private$.stats.actmap[actmeta.argpattern] || 
      {id:actmeta.id,
       plugin:{
         full: actmeta.plugin_fullname,
         name: actmeta.plugin_name,
         tag:  actmeta.plugin_tag
       },
       prior:actmeta.priorpath,calls:<span class="hljs-number">0</span>,done:<span class="hljs-number">0</span>,fails:<span class="hljs-number">0</span>,time:{}}
    
    <span class="hljs-keyword">if</span>( addroute ) {
      <span class="hljs-keyword">var</span> addlog = [ actmeta.sub ? <span class="hljs-string">'SUB'</span> : <span class="hljs-string">'ADD'</span>, 
                     actmeta.id, common.argpattern(pattern) ]
      <span class="hljs-keyword">var</span> isplugin = self.context.isplugin
      <span class="hljs-keyword">var</span> logger   = self.log.log || self.log

      <span class="hljs-keyword">if</span>( !isplugin ) {
        addlog.unshift(<span class="hljs-string">'-'</span>)
        addlog.unshift(<span class="hljs-string">'-'</span>)
        addlog.unshift(<span class="hljs-string">'-'</span>)
      }

      logger.debug.apply( self, addlog )
      private$.actrouter.add(pattern,actmeta)
    }

    <span class="hljs-keyword">return</span> self
  }


  
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_findact</span><span class="hljs-params">(args)</span> </span>{
    <span class="hljs-keyword">var</span> actmeta = private$.actrouter.find(args)

    <span class="hljs-keyword">if</span>( !actmeta ) {
      actmeta = private$.clientrouter.find(args)
    }

    <span class="hljs-keyword">return</span> actmeta
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_hasact</span><span class="hljs-params">(args)</span> </span>{
    <span class="hljs-keyword">return</span> !!private$.actrouter.find(args)
  }



  root.findpins = root.pinact = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> pins = []
    <span class="hljs-keyword">var</span> patterns = _.flatten(arr(<span class="hljs-built_in">arguments</span>))
    _.each( patterns, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(pattern)</span> </span>{
      pattern = _.isString(pattern) ? jsonic(pattern) : pattern
      pins = pins.concat( _.map( private$.actrouter.list(pattern), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(desc)</span> </span>{<span class="hljs-keyword">return</span> desc.match} ) )
    })
    <span class="hljs-keyword">return</span> pins
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_actroutes</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> private$.actrouter.toString(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d)</span> </span>{
      <span class="hljs-keyword">var</span> s = <span class="hljs-string">'F='</span>

      <span class="hljs-keyword">if</span>( d.plugin_fullname ) {
        s+=d.plugin_fullname+<span class="hljs-string">'/'</span>
      }

      s+=d.id

      <span class="hljs-keyword">while</span>( d.priormeta ) {
        d = d.priormeta
        s+=<span class="hljs-string">';'</span>

        <span class="hljs-keyword">if</span>( d.plugin_fullname ) {
          s+=d.plugin_fullname+<span class="hljs-string">'/'</span>
        }

        s+=d.id

      }
      <span class="hljs-keyword">return</span> s
    })
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_list</span><span class="hljs-params">( args )</span> </span>{
    <span class="hljs-keyword">var</span> found = private$.actrouter.list( args )
    
    found = _.map( found, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(entry)</span> </span>{
      <span class="hljs-keyword">return</span> entry.match
    })
    <span class="hljs-keyword">return</span> found
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_act_if</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> args = norma(<span class="hljs-string">'{execute:b actargs:.*}'</span>,<span class="hljs-built_in">arguments</span>)

    <span class="hljs-keyword">if</span>( args.execute ) {
      <span class="hljs-keyword">return</span> self.act.apply( self, args.actargs )
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> self;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Perform an action. The propeties of the first argument are matched against 
known patterns, and the most specific one wins.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_act</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">var</span> spec    = parse_pattern( self, common.arrayify(<span class="hljs-built_in">arguments</span>), <span class="hljs-string">'done:f?'</span> )
    <span class="hljs-keyword">var</span> args    = spec.pattern
    <span class="hljs-keyword">var</span> actcb   = spec.done
    <span class="hljs-keyword">var</span> actmeta = self.findact(args)</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>action pattern found</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>( actmeta ) {
      do_act(self,actmeta,<span class="hljs-literal">false</span>,args,actcb)
      <span class="hljs-keyword">return</span> self;
    }

    <span class="hljs-keyword">if</span>( _.isObject( args.default$ ) ) {
      self.log.debug(<span class="hljs-string">'act'</span>,<span class="hljs-string">'-'</span>,<span class="hljs-string">'-'</span>,<span class="hljs-string">'DEFAULT'</span>,self.util.clean(args))
      <span class="hljs-keyword">if</span>( actcb ) actcb.call( self, <span class="hljs-literal">null</span>, _.clone(args.default$) );
      <span class="hljs-keyword">return</span> self;
    }
    
    <span class="hljs-keyword">var</span> err = error(<span class="hljs-string">'act_not_found'</span>,{args:args})
    logging.log_act_not_found( self, err )

    <span class="hljs-keyword">if</span>( so.debug.fragile ) <span class="hljs-keyword">throw</span> err;

    <span class="hljs-keyword">if</span>( actcb ) actcb.call( self, err );
    <span class="hljs-keyword">return</span> self;
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_wrap</span><span class="hljs-params">(pin,wrapper)</span> </span>{
    <span class="hljs-keyword">var</span> pinthis = <span class="hljs-keyword">this</span>

    pin = _.isArray(pin) ? pin : [pin]
    _.each(pin, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p)</span> </span>{
      _.each( pinthis.pinact(pin), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(actpattern)</span> </span>{
        pinthis.add(actpattern,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(args,done)</span> </span>{
          wrapper.call(<span class="hljs-keyword">this</span>,args,done)
        })
      })
    })
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>close seneca instance
sets public seneca.closed property</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_close</span><span class="hljs-params">(done)</span> </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
    
    self.closed = <span class="hljs-literal">true</span>

    self.log.debug(<span class="hljs-string">'close'</span>,<span class="hljs-string">'start'</span>)
    self.act(<span class="hljs-string">'role:seneca,cmd:close'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> </span>{
      <span class="hljs-keyword">this</span>.log.debug(<span class="hljs-string">'close'</span>,<span class="hljs-string">'end'</span>,err)
      <span class="hljs-keyword">if</span>( _.isFunction(done) ) <span class="hljs-keyword">return</span> done.call(<span class="hljs-keyword">this</span>,err);
    })
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>useful when defining services!
note: has EventEmitter.once semantics
if using .on(‘ready’,fn) it will be be called for each ready event</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_ready</span><span class="hljs-params">(ready)</span> </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">if</span>( _.isFunction(ready) ) {
      self.once(<span class="hljs-string">'ready'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
        <span class="hljs-keyword">try</span> {
          ready.call(self)
        }
        <span class="hljs-keyword">catch</span>(e) {
          self.die(<span class="hljs-string">'ready_failed'</span>,e,ready)
        }
      })

      <span class="hljs-keyword">if</span>( !private$.wait_for_ready ) {
        private$.wait_for_ready = <span class="hljs-literal">true</span>
        self.act(<span class="hljs-string">'role:seneca,ready:true,gate$:true'</span>)
      }
    }

    <span class="hljs-keyword">return</span> self;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>use(‘pluginname’) - built-in, or provide calling code ‘require’ as seneca opt
use( require(‘pluginname’) ) - plugin object, init will be called
if first arg has property senecaplugin </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_use</span><span class="hljs-params">( arg0, arg1, arg2 )</span> </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>, plugindesc;</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Legacy options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>( <span class="hljs-string">'options'</span> == arg0 ) {
      self.options( arg1 )
      <span class="hljs-keyword">return</span> self
    }

    <span class="hljs-keyword">try</span> {
      plugindesc = private$.use( arg0, arg1, arg2 )
    }
    <span class="hljs-keyword">catch</span>(e) {
      <span class="hljs-keyword">return</span> self.die( <span class="hljs-string">'plugin_'</span>+e.code, e );
    }

    self.register( plugindesc, plugindesc.callback )

    <span class="hljs-keyword">return</span> self
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>TODO: move repl functionality to seneca-reply</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  root.inrepl = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    self.on(<span class="hljs-string">'act-out'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      logging.handlers.print.apply(<span class="hljs-literal">null</span>,arr(<span class="hljs-built_in">arguments</span>))
    })
    
    self.on(<span class="hljs-string">'error'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> </span>{
      <span class="hljs-keyword">var</span> args = arr(<span class="hljs-built_in">arguments</span>).slice()
      args.unshift(<span class="hljs-string">'ERROR: '</span>)
      logging.handlers.print.apply(<span class="hljs-literal">null</span>,arr(args))
    })
  }


  root.startrepl = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(in_opts)</span> </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">var</span> repl_opts = _.extend({repl:{listen:<span class="hljs-number">10170</span>}},so,in_opts)
    
    net.createServer(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(socket)</span> </span>{
      <span class="hljs-keyword">var</span> actout =  <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        socket.write(<span class="hljs-string">''</span>+arr(<span class="hljs-built_in">arguments</span>)+<span class="hljs-string">'\n'</span>)
      }
      
      <span class="hljs-keyword">var</span> r = repl.start({
        prompt: <span class="hljs-string">'seneca '</span>+socket.remoteAddress+<span class="hljs-string">':'</span>+socket.remotePort+<span class="hljs-string">'&gt; '</span>, 
        input: socket, output: socket, terminal: <span class="hljs-literal">true</span>, useGlobal: <span class="hljs-literal">false</span>
      })
      
      r.on(<span class="hljs-string">'exit'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        self.removeListener(<span class="hljs-string">'act-out'</span>,actout)
        socket.end()
      })
      
      r.context.seneca = self.delegate()
      
      <span class="hljs-keyword">var</span> orig_act = r.context.seneca.act
      r.context.seneca.act = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">var</span> args = arr(<span class="hljs-built_in">arguments</span>)
        args.repl$=<span class="hljs-literal">true</span>
        orig_act.apply(self,args)
        <span class="hljs-keyword">return</span> r.context.seneca
      }

      self.on(<span class="hljs-string">'act-out'</span>,actout)
      
    }).listen(repl_opts.repl.listen)
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>/ Return self. Mostly useful as a check that this is a Seneca instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_seneca</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Describe this instance using the form: Seneca/VERSION/ID</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_toString</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.name
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">do_act</span><span class="hljs-params">( instance, actmeta, prior_ctxt, origargs, cb )</span> </span>{
    <span class="hljs-keyword">var</span> args = _.clone(origargs)
    prior_ctxt = prior_ctxt || {chain:[],entry:<span class="hljs-literal">true</span>,depth:<span class="hljs-number">1</span>}

    <span class="hljs-keyword">var</span> actid    = ( args.actid$ || instance.idgen() )
    <span class="hljs-keyword">var</span> actstart = <span class="hljs-built_in">Date</span>.now()

    cb = cb || common.noop

    <span class="hljs-keyword">if</span>( act_cache_check( instance, args, prior_ctxt, cb ) ) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">var</span> actstats = act_stats_call( actmeta.pattern )</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>build callargs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> callargs = args
    callargs.actid$ = actid

    callargs.meta$ = {
      id:      actid,
      start:   actstart,
      pattern: actmeta.argpattern,
      action:  actmeta.id,
      entry:   prior_ctxt.entry,
      chain:   prior_ctxt.chain
    }
    

    logging.log_act_in( root, {actid:actid}, actmeta, callargs, prior_ctxt )
    
    instance.emit(<span class="hljs-string">'act-in'</span>, callargs)

    <span class="hljs-keyword">var</span> delegate = act_make_delegate( instance, callargs, actmeta, prior_ctxt )

    <span class="hljs-keyword">if</span>( delegate.fixedargs ) {
      callargs = _.extend({},callargs,delegate.fixedargs)
    }


    <span class="hljs-keyword">var</span> act_done = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> </span>{
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">var</span> actend = <span class="hljs-built_in">Date</span>.now()
        private$.timestats.point( actend-actstart, actmeta.argpattern )

        prior_ctxt.depth--
        prior_ctxt.entry = prior_ctxt.depth &lt;= <span class="hljs-number">0</span>
        
        <span class="hljs-keyword">var</span> result  = arr(<span class="hljs-built_in">arguments</span>)
        <span class="hljs-keyword">var</span> call_cb = <span class="hljs-literal">true</span>

        <span class="hljs-keyword">if</span>( so.actcache ) {
          private$.actcache.set(actid,{
            result:result,
            actmeta:actmeta,
            when:<span class="hljs-built_in">Date</span>.now()
          })
        }

        <span class="hljs-keyword">if</span>( err ) {
          private$.stats.act.fails++
          actstats.fails++

          call_cb = act_error(instance,err,result,actmeta,cb,actend-actstart,
                              callargs,prior_ctxt)
        }
        <span class="hljs-keyword">else</span> {
          instance.emit(<span class="hljs-string">'act-out'</span>,callargs,result[<span class="hljs-number">1</span>])
          result[<span class="hljs-number">0</span>] = <span class="hljs-literal">null</span>

          logging.log_act_out( 
            instance, {actid:actid,duration:actend-actstart}, 
            actmeta, callargs, result, prior_ctxt )

          private$.stats.act.done++
          actstats.done++
        }

        
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">if</span>( call_cb ) {
            cb.apply(delegate,result) <span class="hljs-comment">// note: err == result[0]</span>
          }
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>for exceptions thrown inside the callback</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">catch</span>( ex ) {
          <span class="hljs-keyword">var</span> err = ex</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>handle throws of non-Error values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span>( !util.isError(ex) ) {
            <span class="hljs-keyword">if</span>( _.isObject(ex) ) {
              err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(common.owndesc(ex,<span class="hljs-number">1</span>))
            }
            <span class="hljs-keyword">else</span> {
              err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">''</span>+ex)
            }
          }

          act_error(instance,err,result,actmeta,cb,actend-actstart,
                    callargs,prior_ctxt)
        }
      }
      <span class="hljs-keyword">catch</span>(ex) {
        instance.emit(<span class="hljs-string">'error'</span>,ex)
      }
    }



    act_param_check( origargs, actmeta, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( err )</span> </span>{
      <span class="hljs-keyword">if</span>( err ) <span class="hljs-keyword">return</span> act_done(err);

      <span class="hljs-keyword">var</span> execspec = {
        id:      actid,
        gate:    prior_ctxt.entry &amp;&amp; !!callargs.gate$,
        ungate:  !!callargs.ungate$,
        desc:    actmeta.argpattern,
        cb:      act_done,

        plugin: {
          name: actmeta.plugin_name,
          tag:  actmeta.plugin_tag
        },

        fn:<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cb)</span> </span>{
          delegate.good = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(out)</span> </span>{
            cb(<span class="hljs-literal">null</span>,out)
          }

          delegate.bad = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> </span>{
            cb(err)
          }

          actmeta.func.call(delegate,callargs,cb)
        },
      }

      private$.executor.execute(execspec)
    })
  }


  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">act_error</span><span class="hljs-params">( instance, err, result, actmeta, cb, 
                      duration, callargs, prior_ctxt )</span> 
  </span>{
    <span class="hljs-keyword">var</span> call_cb = <span class="hljs-literal">true</span>

    <span class="hljs-keyword">if</span>( !err.seneca ) {
      <span class="hljs-keyword">var</span> origerr = err
      err = error(<span class="hljs-string">'act_execute'</span>,_.extend(
        {},
        origerr.details,
        {
          message:  err.message,
          pattern:  err.details ? err.details.desc : <span class="hljs-string">''</span>,
          fn:       actmeta.func,
          cb:       cb,
          instance: instance.toString()
        }))
      err.stack = origerr.stack
      err.callpoint = origerr.callpoint
      result[<span class="hljs-number">0</span>] = err
    }
      
    err.details = err.details || {}
    err.details.plugin = err.details.plugin || {}

    logging.log_act_err( root, {actid:callargs.actid$,duration:duration}, 
                         actmeta, callargs, prior_ctxt, err )

    instance.emit(<span class="hljs-string">'act-err'</span>,callargs,err,result[<span class="hljs-number">1</span>])

    <span class="hljs-keyword">if</span>( so.errhandler ) {
      call_cb = !so.errhandler(err)
    }

    <span class="hljs-keyword">return</span> call_cb
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>Check if actid has already been seen, and if action cache is active,
then provide cached result, if any. Return true in this case.</p>
<ul>
<li><em>instance</em>    (object)    &rarr;  seneca instance</li>
<li><em>args</em>        (object)    &rarr;  action arguments</li>
<li><em>prior_ctxt</em>  (object?)   &rarr;  prior action context, if any</li>
<li><em>actcb</em>       (function)  &rarr;  action arguments</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">act_cache_check</span><span class="hljs-params">( instance, args, prior_ctxt, actcb )</span> </span>{
    assert.ok( _.isObject(instance), <span class="hljs-string">'act_cache_check; instance; isObject'</span>)
    assert.ok( _.isObject(args),     <span class="hljs-string">'act_cache_check; args; isObject'</span>)
    assert.ok( !prior_ctxt || _.isObject(prior_ctxt),     
               <span class="hljs-string">'act_cache_check; prior_ctxt; isObject'</span>)
    assert.ok( !actcb || _.isFunction(actcb),  
               <span class="hljs-string">'act_cache_check; actcb; isFunction'</span>)

    <span class="hljs-keyword">var</span> actid = args.actid$

    <span class="hljs-keyword">if</span>( <span class="hljs-literal">null</span> != actid &amp;&amp; so.actcache ) {
      <span class="hljs-keyword">var</span> actdetails = private$.actcache.get(actid)      

      <span class="hljs-keyword">if</span>( actdetails ) {
        <span class="hljs-keyword">var</span> actmeta = actdetails.actmeta || {}
        private$.stats.act.cache++
        
        logging.log_act_cache( instance, {actid:actid}, actmeta, args, prior_ctxt )
        
        <span class="hljs-keyword">if</span>( actcb ) actcb.apply( instance, actdetails.result );
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      }
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>Resolve action stats object, creating if ncessary, and count a call.</p>
<ul>
<li><em>pattern</em>     (string)    &rarr;  action pattern</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">act_stats_call</span><span class="hljs-params">( pattern )</span> </span>{
    <span class="hljs-keyword">var</span> actstats = (private$.stats.actmap[pattern] = 
                    private$.stats.actmap[pattern] || {})

    private$.stats.act.calls++
    actstats.calls++

    <span class="hljs-keyword">return</span> actstats
  }
  


  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">act_make_delegate</span><span class="hljs-params">( instance, callargs, actmeta, prior_ctxt )</span> </span>{
    <span class="hljs-keyword">var</span> delegate_args = {}
    <span class="hljs-keyword">if</span>( <span class="hljs-literal">null</span> != callargs.gate$ ) {
      delegate_args.ungate$ = !!callargs.gate$
    }
    <span class="hljs-keyword">var</span> delegate = instance.delegate( delegate_args )</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>automate actid log insertion</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-comment">/*
    delegate.log = function() {
      var args = arr(arguments)

      if( _.isFunction(actmeta.log) ) {
        var entries = [args[0],'ACT',actid].concat(args.slice(1))
        actmeta.log.apply(instance,entries)
      }
      else {
        instance.log.apply(
          instance,
          [args[0],'-','-','-','ACT',actid]
            .concat(args.slice(1)))
      }
    }
    delegate.log.log = actmeta.log
    logging.makelogfuncs(delegate)
     */</span>

    <span class="hljs-keyword">if</span>( actmeta.priormeta ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>TODO: deprecate parent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      delegate.prior = delegate.parent = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(prior_args,prior_cb)</span> </span>{
        prior_args = _.clone(prior_args)
        
        <span class="hljs-keyword">var</span> sub_prior_ctxt = _.clone(prior_ctxt)
        sub_prior_ctxt.chain = _.clone(prior_ctxt.chain)
        sub_prior_ctxt.chain.push(callargs.actid$)
        sub_prior_ctxt.entry = <span class="hljs-literal">false</span>
        sub_prior_ctxt.depth++;
        
        <span class="hljs-keyword">delete</span> prior_args.actid$
        <span class="hljs-keyword">delete</span> prior_args.meta$

        do_act(delegate,actmeta.priormeta,sub_prior_ctxt,prior_args,prior_cb)
      }
    }
    <span class="hljs-keyword">else</span> delegate.prior = common.nil

    <span class="hljs-keyword">return</span> delegate;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>Check if action parameters pass parambulator spec, if any.</p>
<ul>
<li><em>args</em>     (object)    &rarr;  action arguments</li>
<li><em>actmeta</em>  (object)    &rarr;  action meta data</li>
<li><em>done</em>     (function)  &rarr;  callback function</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">act_param_check</span><span class="hljs-params">( args, actmeta, done )</span> </span>{
    assert.ok( _.isObject(args),    <span class="hljs-string">'act_param_check; args; isObject'</span>)
    assert.ok( _.isObject(actmeta), <span class="hljs-string">'act_param_check; actmeta; isObject'</span>)
    assert.ok( _.isFunction(done),  <span class="hljs-string">'act_param_check; done; isFunction'</span>)

    <span class="hljs-keyword">if</span>( actmeta.parambulator ) {
      actmeta.parambulator.validate(args,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> </span>{
        <span class="hljs-keyword">if</span>(err) <span class="hljs-keyword">return</span> done( 
          error(<span class="hljs-string">'act_invalid_args'</span>, 
                {pattern:actmeta.pattern,message:err.message,args:args} ));
        <span class="hljs-keyword">return</span> done();
      })
    } 
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> done();
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>string args override object args</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parse_pattern</span><span class="hljs-params">(instance,args,normaspec,fixed)</span> </span>{
    args = norma(<span class="hljs-string">'{strargs:s? objargs:o? moreobjargs:o? '</span>+(normaspec||<span class="hljs-string">''</span>)+<span class="hljs-string">'}'</span>, args)

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">return</span> _.extend(
        args,
        { pattern: _.extend(</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>Precedence of arguments in add,act is left-to-right</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          args.moreobjargs ? args.moreobjargs : {},
          args.objargs ? args.objargs : {},
          args.strargs ? jsonic( args.strargs ) : {},

          fixed || {} )
        })
    }
    <span class="hljs-keyword">catch</span>( e ) {
      <span class="hljs-keyword">var</span> col = <span class="hljs-number">1</span>==e.line?e.column-<span class="hljs-number">1</span>:e.column</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>throw instance.fail(‘add_string_pattern_syntax’,{argstr:args,syntax:e.message,line:e.line,col:col})</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">throw</span> error(<span class="hljs-string">'add_string_pattern_syntax'</span>,{argstr:args,syntax:e.message,line:e.line,col:col})
    }
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_fix</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">var</span> defargs = parse_pattern(self,<span class="hljs-built_in">arguments</span>)

    <span class="hljs-keyword">var</span> fix = self.delegate( defargs.pattern )

    fix.add = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> args    = parse_pattern(fix,<span class="hljs-built_in">arguments</span>,<span class="hljs-string">'rest:.*'</span>,defargs.pattern)
      <span class="hljs-keyword">var</span> addargs = [args.pattern].concat(args.rest)
      <span class="hljs-keyword">return</span> self.add.apply(fix,addargs)
    }
    
    <span class="hljs-keyword">return</span> fix
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_delegate</span><span class="hljs-params">(fixedargs)</span> </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">var</span> delegate = <span class="hljs-built_in">Object</span>.create(self)
    <span class="hljs-keyword">var</span> act = self.act

    delegate.did = nid()

    delegate.act = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> spec = parse_pattern( self, common.arrayify(<span class="hljs-built_in">arguments</span>), <span class="hljs-string">'done:f?'</span> )
      <span class="hljs-keyword">var</span> args = spec.pattern
      <span class="hljs-keyword">var</span> cb   = spec.done</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>var argscb = handle_act_args(this,arr(arguments))</p>

            </div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>can’t override fixedargs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      args = _.extend({},args,fixedargs)</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>var cb = argscb[1]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
      act.call(<span class="hljs-keyword">this</span>,args,cb)

      <span class="hljs-keyword">return</span> delegate
    }

    <span class="hljs-keyword">var</span> strdesc
    delegate.toString = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">if</span>( strdesc ) <span class="hljs-keyword">return</span> strdesc;
      <span class="hljs-keyword">var</span> vfa = {}
      _.each(fixedargs,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v,k)</span> </span>{
        <span class="hljs-keyword">if</span>( ~k.indexOf(<span class="hljs-string">'$'</span>) ) <span class="hljs-keyword">return</span>;
        vfa[k]=v
      })

      strdesc = self.toString()+(_.keys(vfa).length?<span class="hljs-string">'/'</span>+common.owndesc(vfa,<span class="hljs-number">0</span>,<span class="hljs-literal">false</span>):<span class="hljs-string">''</span>)

      <span class="hljs-keyword">return</span> strdesc
    }
    
    delegate.delegate = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(further_fixedargs)</span> </span>{
      <span class="hljs-keyword">var</span> args = _.extend({},fixedargs,further_fixedargs||{})
      <span class="hljs-keyword">return</span> self.delegate.call(<span class="hljs-keyword">this</span>,args)
    }

    delegate.fixedargs = fixedargs</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>Somewhere to put contextual data for this delegate.
For example, data for individual web requests.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    delegate.context = {}

    delegate.client = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">return</span> self.client.call(<span class="hljs-keyword">this</span>,<span class="hljs-built_in">arguments</span>)
    }

    delegate.listen = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">return</span> self.listen.call(<span class="hljs-keyword">this</span>,<span class="hljs-built_in">arguments</span>)
    }

    <span class="hljs-keyword">return</span> delegate
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_options</span><span class="hljs-params">( options )</span> </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    so = private$.exports.options = 
      (<span class="hljs-literal">null</span> == options) ? optioner.get() : optioner.set( options );

    <span class="hljs-keyword">if</span>( options &amp;&amp; options.log ) {
      private$.logrouter = logging.makelogrouter(so.log)
      self.log = logging.makelog(private$.logrouter,self.id)
    }

    <span class="hljs-keyword">return</span> so
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_start</span><span class="hljs-params">( errhandler )</span> </span>{
    <span class="hljs-keyword">var</span> sd = <span class="hljs-keyword">this</span>.delegate()
    <span class="hljs-keyword">var</span> options = sd.options()
    options.zig = options.zig || {}


    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">make_fn</span><span class="hljs-params">(self,origargs)</span> </span>{
      <span class="hljs-keyword">var</span> args = parse_pattern(self,origargs,<span class="hljs-string">'fn:f?'</span>)

      <span class="hljs-keyword">var</span> actargs = _.extend(
        {},
        args.moreobjargs ? args.moreobjargs : {},
        args.objargs ? args.objargs : {},
        args.strargs ? jsonic( args.strargs ) : {}
      )

      <span class="hljs-keyword">var</span> fn
      <span class="hljs-keyword">if</span>( args.fn ) {
        fn = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data,done)</span></span>{
          <span class="hljs-keyword">return</span> args.fn.call(self,data,done)
        }
      }
      <span class="hljs-keyword">else</span> {
        fn = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data,done)</span></span>{
          <span class="hljs-comment">/* jshint evil:true */</span>

          <span class="hljs-keyword">if</span>( args.strargs ) {
            <span class="hljs-keyword">var</span> $ = data
            _.each(actargs,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v,k)</span></span>{
              <span class="hljs-keyword">if</span>( _.isString(v) &amp;&amp; <span class="hljs-number">0</span>===v.indexOf(<span class="hljs-string">'$.'</span>) ) {
                actargs[k] = <span class="hljs-built_in">eval</span>(v)
              }
            })
          }

          self.act(actargs,done)
          <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
        }
        fn.nm = args.strargs
      }

      <span class="hljs-keyword">return</span> fn
    }


    <span class="hljs-keyword">var</span> dzig = zig({
      timeout: options.zig.timeout || options.timeout,
      trace: options.zig.trace
    })

    dzig.start(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
      <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
      dzig.end(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
        <span class="hljs-keyword">if</span>( errhandler ) errhandler.apply(self,<span class="hljs-built_in">arguments</span>);
      })
    })
    
    sd.end = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cb)</span></span>{
      <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
      dzig.end(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
        <span class="hljs-keyword">if</span>( cb ) <span class="hljs-keyword">return</span> cb.apply(self,<span class="hljs-built_in">arguments</span>);
        <span class="hljs-keyword">if</span>( errhandler ) <span class="hljs-keyword">return</span> errhandler.apply(self,<span class="hljs-built_in">arguments</span>);
      })
      <span class="hljs-keyword">return</span> self
    }

    sd.wait = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
      dzig.wait(make_fn(<span class="hljs-keyword">this</span>,<span class="hljs-built_in">arguments</span>))
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
    }

    sd.step = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
      dzig.step(make_fn(<span class="hljs-keyword">this</span>,<span class="hljs-built_in">arguments</span>))
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
    }

    sd.run = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
      dzig.run(make_fn(<span class="hljs-keyword">this</span>,<span class="hljs-built_in">arguments</span>))
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
    }

    sd.if = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cond)</span></span>{
      dzig.if(cond)
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
    }

    sd.endif = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
      dzig.endif()
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
    }

    sd.fire = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
      dzig.step(make_fn(<span class="hljs-keyword">this</span>,<span class="hljs-built_in">arguments</span>))
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
    }

    <span class="hljs-keyword">return</span> sd
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>Create entity delegate.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> sd = root.delegate()
  sd.log = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> args = [<span class="hljs-string">'entity'</span>]
    root.log.apply(<span class="hljs-keyword">this</span>,args.concat(arr(<span class="hljs-built_in">arguments</span>)))
  }
  logging.makelogfuncs(sd)</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>Template entity that makes all others.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  private$.entity = make_entity({},sd)</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>DEPRECATED 
for use with async</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  root.next_act = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> si   = <span class="hljs-keyword">this</span> || root
    <span class="hljs-keyword">var</span> args = arr(<span class="hljs-built_in">arguments</span>)
    
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(next)</span> </span>{
      args.push(next)
      si.act.apply(si,args)
    }
  }



  root.gate = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> gated = <span class="hljs-keyword">this</span>.delegate({gate$:<span class="hljs-literal">true</span>})
    <span class="hljs-keyword">return</span> gated
  }


  root.ungate = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> ungated = <span class="hljs-keyword">this</span>.delegate({gate$:<span class="hljs-literal">false</span>})
    <span class="hljs-keyword">return</span> ungated
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>Add builtin actions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  root.add( {role:<span class="hljs-string">'seneca'</span>,  stats:<span class="hljs-literal">true</span>},  action_seneca_stats )
  root.add( {role:<span class="hljs-string">'seneca'</span>,  ready:<span class="hljs-literal">true</span>},  action_seneca_ready )
  root.add( {role:<span class="hljs-string">'seneca'</span>,  cmd:<span class="hljs-string">'close'</span>}, action_seneca_close )
  root.add( {role:<span class="hljs-string">'options'</span>, cmd:<span class="hljs-string">'get'</span>},   action_options_get  )</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>Define builtin actions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">action_seneca_close</span><span class="hljs-params">(args,done)</span> </span>{
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'close'</span>)
    done()
  }


  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">action_seneca_ready</span><span class="hljs-params">(args,done)</span> </span>{
    private$.wait_for_ready = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'ready'</span>)
    done()
  }


  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">action_seneca_stats</span><span class="hljs-params">( args, done )</span> </span>{
    <span class="hljs-keyword">var</span> stats

    <span class="hljs-keyword">if</span>( args.pattern &amp;&amp; private$.stats.actmap[args.pattern] ) {
      stats = private$.stats.actmap[args.pattern]
      stats.time = private$.timestats.calculate(args.pattern)
    }
    <span class="hljs-keyword">else</span> {
      stats = _.clone(private$.stats)
      stats.now    = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()
      stats.uptime = stats.now - stats.start

      stats.now   = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(stats.now).toISOString()
      stats.start = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(stats.start).toISOString()

      <span class="hljs-keyword">var</span> summary = 
            (<span class="hljs-literal">null</span> == args.summary &amp;&amp; <span class="hljs-literal">false</span>) || 
            (<span class="hljs-regexp">/^false$/i</span>.exec(args.summary) ? <span class="hljs-literal">false</span> : !!(args.summary) )

      <span class="hljs-keyword">if</span>( summary ) {
        stats.actmap = <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>
      }
      <span class="hljs-keyword">else</span> {
        _.each( private$.stats.actmap, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a,p)</span> </span>{ 
          private$.stats.actmap[p].time = private$.timestats.calculate(p) 
        })
      }
    }

    done(<span class="hljs-literal">null</span>,stats)
  }


  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">action_options_get</span><span class="hljs-params">( args, done )</span> </span>{
    <span class="hljs-keyword">var</span> options = private$.optioner.get()
    
    <span class="hljs-keyword">var</span> base = args.base || <span class="hljs-literal">null</span>
    <span class="hljs-keyword">var</span> root = base ? (options[base]||{}) : options 
    <span class="hljs-keyword">var</span> val  = args.key ? root[args.key] : root

    done(<span class="hljs-literal">null</span>,common.copydata(val))
  }


  <span class="hljs-keyword">return</span> root
}</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Utilities</p>

            </div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>Error arguments:
code
code, values
code, Error, values
Error (optional code,message properties), values
values (optional code,message properties)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle_error_args</span><span class="hljs-params">( args, ctxt )</span> </span>{
  args = arr(args)

  <span class="hljs-keyword">var</span> first = args[<span class="hljs-number">0</span>]
  <span class="hljs-keyword">var</span> valstart = <span class="hljs-number">1</span>

  <span class="hljs-keyword">var</span> code = <span class="hljs-string">'unknown'</span>
  code = _.isString(first) ? first : code 
  code = util.isError(first) &amp;&amp; _.isString(first.code) ? first.code : code
  code = _.isObject(first) &amp;&amp; _.isString(first.code) ? first.code : code 


  <span class="hljs-keyword">if</span>( _.isObject(first) &amp;&amp; !util.isError(first) ) {
    valstart = <span class="hljs-number">0</span>
  }

  <span class="hljs-keyword">var</span> error = util.isError(first) ? 
        first : util.isError(args[<span class="hljs-number">1</span>]) ? (valstart=<span class="hljs-number">2</span>,args[<span class="hljs-number">1</span>]) : <span class="hljs-literal">null</span>

  <span class="hljs-keyword">var</span> valmap = _.isObject(args[valstart]) ? args[valstart] : {}

  <span class="hljs-keyword">var</span> msgmap = ERRMSGMAP()
  <span class="hljs-keyword">var</span> message = (msgmap[ctxt.plugin] &amp;&amp; msgmap[ctxt.plugin][code])
  message = _.isString(message) ? 
    message : (_.isString(valmap.message) &amp;&amp; valmap.message)
  message = _.isString(message) ? 
    message : (error &amp;&amp; _.isString(error.message) &amp;&amp; error.message)


  <span class="hljs-keyword">if</span>( !_.isString(message) ) {
    <span class="hljs-keyword">try</span> {
      message = code+<span class="hljs-string">': '</span>+util.inspect(args)
    }
    <span class="hljs-keyword">catch</span>(e) {
      message = code
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>workaround to prevent underscore blowing up if properties are not found
reserved words and undefined need to be suffixed with $ 
in the template interpolates</p>

            </div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>TODO: use eraro</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-keyword">var</span> valstrmap = {}
  _.each(valmap,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(val,key)</span> </span>{
    <span class="hljs-comment">/* jshint evil:true */</span>
    <span class="hljs-keyword">try</span> { <span class="hljs-built_in">eval</span>(<span class="hljs-string">'var '</span>+key+<span class="hljs-string">';'</span>) } <span class="hljs-keyword">catch</span>(e) { key = key+<span class="hljs-string">'$'</span> }
    <span class="hljs-keyword">if</span>( {<span class="hljs-string">'undefined'</span>:<span class="hljs-number">1</span>,<span class="hljs-string">'NaN'</span>:<span class="hljs-number">1</span>}[key] ) { key = key+<span class="hljs-string">'$'</span> }
    valstrmap[key] = (_.isObject(val) ? common.owndesc(val,<span class="hljs-number">1</span>) : <span class="hljs-string">''</span>+val)
  })

  <span class="hljs-keyword">var</span> done = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">while</span>( !done ) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">var</span> tm = _.template( message )
      message = tm( valstrmap )
      done = <span class="hljs-literal">true</span>
    }
    <span class="hljs-keyword">catch</span>(e) {
      <span class="hljs-keyword">if</span>(e <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">ReferenceError</span>) {
        <span class="hljs-keyword">var</span> m = <span class="hljs-regexp">/ReferenceError:\s+(.*?)\s+/</span>.exec(e.toString())
        <span class="hljs-keyword">if</span>( m &amp;&amp; m[<span class="hljs-number">1</span>] ) {
          valstrmap[m[<span class="hljs-number">1</span>]]=<span class="hljs-string">"["</span>+m[<span class="hljs-number">1</span>]+<span class="hljs-string">"?]"</span>
        }
        <span class="hljs-keyword">else</span> done = <span class="hljs-literal">true</span>
      }
      <span class="hljs-keyword">else</span> {
        done = <span class="hljs-literal">true</span>
        message = message+<span class="hljs-string">' VALUES:'</span>+common.owndesc(valmap,<span class="hljs-number">2</span>)
      }
    }
  }

  <span class="hljs-keyword">return</span> {
    code:      code,
    error:     error,
    message:   message,
    remaining: args.slice(valstart),
    valmap:    valmap,
    callback:  _.isFunction(args[valstart]) ? args[valstart] : <span class="hljs-literal">null</span>
  }
}



<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">makedie</span><span class="hljs-params">( instance, ctxt )</span> </span>{
  ctxt = _.extend(ctxt,instance.die?instance.die.context:{})

  <span class="hljs-keyword">var</span> die = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> args = handle_error_args(<span class="hljs-built_in">arguments</span>,ctxt)

    <span class="hljs-keyword">var</span> code    = args.code
    <span class="hljs-keyword">var</span> err     = args.error
    <span class="hljs-keyword">var</span> message = args.message

    <span class="hljs-keyword">var</span> so = instance.options()</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>stayalive is only for testing, do not use in production</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> stayalive = so.test.stayalive || (err &amp;&amp; err.stayalive)

    <span class="hljs-keyword">var</span> logargs  = [ctxt.type, ctxt.plugin, ctxt.tag, ctxt.id, code]
          .concat( message &amp;&amp; message != code ? message : <span class="hljs-keyword">void</span> <span class="hljs-number">0</span> )
          .concat( args.remaining )

    <span class="hljs-keyword">if</span>( !err ) {
      err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>( code )
    }

    instance.log.fatal.apply( instance, logargs )

    <span class="hljs-keyword">var</span> stack = err.stack
    stack = stack.replace(<span class="hljs-regexp">/^.*?\n/</span>,<span class="hljs-string">'\n'</span>)

    <span class="hljs-keyword">var</span> procdesc = process.pid <span class="hljs-comment">// + more</span>

    <span class="hljs-keyword">var</span> stderrmsg =
          <span class="hljs-string">"\n\n"</span>+
          <span class="hljs-string">"Seneca Fatal Error\n"</span>+
          <span class="hljs-string">"==================\n\n"</span>+
          <span class="hljs-string">"Message: "</span>+message+<span class="hljs-string">"\n\n"</span>+
          <span class="hljs-string">"Code: "</span>+code+<span class="hljs-string">"\n\n"</span>+
          <span class="hljs-string">"Stack: "</span>+stack+<span class="hljs-string">"\n\n"</span>+
          <span class="hljs-string">"Instance: "</span>+instance.toString()+<span class="hljs-string">"\n\n"</span>+
          <span class="hljs-string">"When: "</span>+<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString()+<span class="hljs-string">"\n\n"</span>+
          <span class="hljs-string">"Log: "</span>+common.owndesc(logargs,<span class="hljs-number">3</span>)+<span class="hljs-string">"\n\n"</span>+
          <span class="hljs-string">"Node: "</span>+util.inspect(process.versions).replace(<span class="hljs-regexp">/\s+/g</span>,<span class="hljs-string">' '</span>)+<span class="hljs-string">"\n\n"</span>+
          <span class="hljs-string">"Process: pid="</span>+procdesc+
          <span class="hljs-string">", path="</span>+process.execPath+
          <span class="hljs-string">", args="</span>+util.inspect(process.argv)+<span class="hljs-string">"\n\n"</span>


    <span class="hljs-keyword">if</span>( stayalive ) {
      <span class="hljs-keyword">throw</span> error(err,code,args.valmap)
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>this blocks, but that’s ok, we want to be sure the error description 
is printed to STDERR</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-built_in">console</span>.error( stderrmsg )</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>terminate process, err (if defined) is from seneca.close</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">die</span><span class="hljs-params">( err )</span> </span>{
      <span class="hljs-keyword">if</span>( !stayalive ) {
        process.nextTick(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
          <span class="hljs-keyword">if</span>( err ) <span class="hljs-built_in">console</span>.error( err );
          <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Terminated at "</span>+(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString())+
                        <span class="hljs-string">". See above for error report.\n\n"</span>)
          process.exit(<span class="hljs-number">1</span>)
        })
      }
    }

    instance.close( die )</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>make sure we close down within options.deathdelay seconds</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>( !stayalive ) {
      <span class="hljs-keyword">var</span> killtimer = setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Terminated (on timeout) at "</span>+(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString())+
                      <span class="hljs-string">".\n\n"</span>)
        process.exit(<span class="hljs-number">2</span>);
      }, so.deathdelay);
      killtimer.unref();
    }
  }

  die.context = ctxt
  
  <span class="hljs-keyword">return</span> die
}



<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">make_trace_act</span><span class="hljs-params">( opts )</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>,<span class="hljs-number">0</span>)
    args.unshift(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString())

    <span class="hljs-keyword">if</span>( opts.stack ) {
      args.push(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'trace...'</span>).stack)
    }

    <span class="hljs-built_in">console</span>.log(args.join(<span class="hljs-string">'\t'</span>))
  }
}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pin_patrun_customizer</span><span class="hljs-params">(pat,data)</span> </span>{
  <span class="hljs-comment">/* jshint validthis:true */</span>

  <span class="hljs-keyword">var</span> pi = <span class="hljs-keyword">this</span>

  <span class="hljs-keyword">var</span> gexers = {}
  _.each(pat, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v,k)</span> </span>{
    <span class="hljs-keyword">if</span>( _.isString(v) &amp;&amp; ~v.indexOf(<span class="hljs-string">'*'</span>) ) {
      <span class="hljs-keyword">delete</span> pat[k]
      gexers[k] = gex(v)
    }
  })</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>handle previous patterns that match this pattern</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> prev     = pi.list(pat)
  <span class="hljs-keyword">var</span> prevfind = prev[<span class="hljs-number">0</span>] &amp;&amp; prev[<span class="hljs-number">0</span>].find
  <span class="hljs-keyword">var</span> prevdata = prev[<span class="hljs-number">0</span>] &amp;&amp; pi.findexact(prev[<span class="hljs-number">0</span>].match)

  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(args,data)</span> </span>{
    <span class="hljs-keyword">var</span> pi  = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> out = data
    _.each(gexers,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(g,k)</span> </span>{
      <span class="hljs-keyword">var</span> v = args[k]
      <span class="hljs-keyword">if</span>( <span class="hljs-literal">null</span> == g.on( v ) ) { out = <span class="hljs-literal">null</span> }
    })

    <span class="hljs-keyword">if</span>( prevfind &amp;&amp; <span class="hljs-literal">null</span> == out ) {
      out = prevfind.call(pi,args,prevdata)
    }

    <span class="hljs-keyword">return</span> out
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>Primary export function, creates a new Seneca instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span><span class="hljs-params">( seneca_options, more_options )</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>Create instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> seneca = make_seneca( _.extend( {}, seneca_options, more_options ))
  <span class="hljs-keyword">var</span> so     = seneca.options()</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>TODO: make these optional
register default plugins</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>( so.default_plugins.basic )        { seneca.use(<span class="hljs-string">'basic'</span>) }
  <span class="hljs-keyword">if</span>( so.default_plugins[<span class="hljs-string">'mem-store'</span>] ) { seneca.use(<span class="hljs-string">'mem-store'</span>) }
  <span class="hljs-keyword">if</span>( so.default_plugins.transport )    { seneca.use(<span class="hljs-string">'transport'</span>) }
  <span class="hljs-keyword">if</span>( so.default_plugins.web )          { seneca.use(<span class="hljs-string">'web'</span>) }</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>Register plugins specified in options.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.each(so.plugins, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(plugindesc)</span> </span>{
    seneca.use(plugindesc)
  })


  <span class="hljs-keyword">return</span> seneca
}</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>To reference builtin loggers when defining logging options.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>init.loghandler = logging.handlers</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>Makes require(‘seneca’).use( … ) work by creating an on-the-fly instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>init.use = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> instance = init()
  <span class="hljs-keyword">return</span> instance.use.apply(instance,arr(<span class="hljs-built_in">arguments</span>))
}</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>Mostly for testing.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span>( <span class="hljs-built_in">require</span>.main === <span class="hljs-built_in">module</span> ) {
  init()
}</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>Minor utils</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">thrower</span><span class="hljs-params">(err)</span> </span>{
  <span class="hljs-keyword">if</span>( err ) <span class="hljs-keyword">throw</span> err;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>Error code messages.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ERRMSGMAP</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> {
    test_msg: <span class="hljs-string">'Test message.'</span>,
    test_prop: <span class="hljs-string">'TESTING: exists: &lt;%=exists%&gt;, notfound:&lt;%=notfound%&gt;, str=&lt;%=str%&gt;, obj=&lt;%=obj%&gt;, arr=&lt;%=arr%&gt;, bool=&lt;%=bool%&gt;, null=&lt;%=null$%&gt;, delete=&lt;%=delete$%&gt;, undefined=&lt;%=undefined$%&gt;, void=&lt;%=void$%&gt;, NaN=&lt;%=NaN$%&gt;'</span>,

    add_string_pattern_syntax: <span class="hljs-string">'Could not add action due to syntax error in pattern string: "&lt;%=argstr%&gt;": Line:&lt;%=line%&gt;, Column:&lt;%=col%&gt;; &lt;%=syntax%&gt;'</span>,
    act_string_args_syntax: <span class="hljs-string">'Could execute action due to syntax error in argument string: "&lt;%=argstr%&gt;": Line:&lt;%=line%&gt;, Column:&lt;%=col%&gt;; &lt;%=syntax%&gt;'</span>,

    add_pattern_object_expected_after_string_pattern: <span class="hljs-string">'Could not add action; unexpected argument; a pattern object or function should follow the pattern string; arguments were: "&lt;%=args%&gt;".'</span>,
    add_pattern_object_expected: <span class="hljs-string">'Could not add action; unexpected argument; a pattern object or string should be the first argument; arguments were: "&lt;%=args%&gt;".'</span>,

    add_action_function_expected: <span class="hljs-string">'Could not add action: the action function should appear after the pattern; arguments were: "&lt;%=args%&gt;".'</span>,
    add_action_metadata_not_an_object: <span class="hljs-string">'Could not add action: the argument after the action function should be a metadata object: &lt;%=actmeta%&gt;.'</span>,

    add_empty_pattern: <span class="hljs-string">'Could not add action, as the action pattern is empty: "&lt;%=args%&gt;"'</span>,

    act_if_expects_boolean: <span class="hljs-string">'The method act_if expects a boolean value as its first argument, was: "&lt;%=first%&gt;".'</span>,

    act_not_found: <span class="hljs-string">'No matching action pattern found for "&lt;%=args%&gt;", and no default result provided (using a default$ property).'</span>,
    act_no_args: <span class="hljs-string">'No action pattern defined in "&lt;%=args%&gt;"; the first argument should be a string or object pattern.'</span>,
    act_invalid_args: <span class="hljs-string">'Action &lt;%=pattern%&gt; has invalid arguments; &lt;%=message%&gt;; arguments were: &lt;%=args%&gt;.'</span>,
    act_execute: <span class="hljs-string">'Action &lt;%=pattern%&gt; failed: &lt;%=message%&gt;.'</span>,
    act_callback: <span class="hljs-string">'Action &lt;%=pattern%&gt; callback threw: &lt;%=message%&gt;.'</span>,


    no_client: <span class="hljs-string">'Transport client was not created; arguments were: "&lt;%=args%&gt;".'</span>,

    invalid_options: <span class="hljs-string">'Invalid options; &lt;%=message%&gt;'</span>,

    plugin_required: <span class="hljs-string">'The &lt;%=name%&gt; plugin depends on the &lt;%=dependency%&gt; plugin, which is not loaded yet.'</span>,
    plugin_init: <span class="hljs-string">'The &lt;%=name%&gt; plugin failed to initialize: &lt;%=plugin_error%&gt;.'</span>,
    plugin_init_timeout: <span class="hljs-string">'The &lt;%=name%&gt; plugin failed to initialize within &lt;%=timeout%&gt; milliseconds (The init:&lt;%=name%&gt; action did not call the "done" callback in time).'</span>,

    export_not_found: <span class="hljs-string">'The export &lt;%=key%&gt; has not been defined by a plugin.'</span>,

    store_cmd_missing: <span class="hljs-string">'Entity data store implementation is missing a command; "&lt;%=cmd%&gt;": "&lt;%=store%&gt;".'</span>,

    sub_function_catch: <span class="hljs-string">'Pattern subscription function threw: &lt;%=message%&gt; on args: &lt;%=args%&gt;, result: &lt;%=result%&gt;.'</span>

  }
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
