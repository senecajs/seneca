<!DOCTYPE html>

<html>
<head>
  <title>seneca.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>seneca.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/* Copyright (c) 2010-2014 Richard Rodger, MIT License */</span>
<span class="hljs-comment">/* jshint node:true, asi:true, eqnull:true */</span>
<span class="hljs-pi">"use strict"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Current version, access using <em>seneca.version</em> property</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> VERSION = <span class="hljs-string">'0.5.18'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Node API modules</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> util     = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>)
<span class="hljs-keyword">var</span> events   = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>)
<span class="hljs-keyword">var</span> net      = <span class="hljs-built_in">require</span>(<span class="hljs-string">'net'</span>)
<span class="hljs-keyword">var</span> repl     = <span class="hljs-built_in">require</span>(<span class="hljs-string">'repl'</span>)
<span class="hljs-keyword">var</span> path     = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)
<span class="hljs-keyword">var</span> buffer   = <span class="hljs-built_in">require</span>(<span class="hljs-string">'buffer'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>External modules</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> _            = <span class="hljs-built_in">require</span>(<span class="hljs-string">'underscore'</span>)
<span class="hljs-keyword">var</span> async        = <span class="hljs-built_in">require</span>(<span class="hljs-string">'async'</span>)
<span class="hljs-keyword">var</span> minimist     = <span class="hljs-built_in">require</span>(<span class="hljs-string">'minimist'</span>)
<span class="hljs-keyword">var</span> nid          = <span class="hljs-built_in">require</span>(<span class="hljs-string">'nid'</span>)
<span class="hljs-keyword">var</span> jsonic       = <span class="hljs-built_in">require</span>(<span class="hljs-string">'jsonic'</span>)
<span class="hljs-keyword">var</span> patrun       = <span class="hljs-built_in">require</span>(<span class="hljs-string">'patrun'</span>)
<span class="hljs-keyword">var</span> parambulator = <span class="hljs-built_in">require</span>(<span class="hljs-string">'parambulator'</span>)
<span class="hljs-keyword">var</span> norma        = <span class="hljs-built_in">require</span>(<span class="hljs-string">'norma'</span>)
<span class="hljs-keyword">var</span> stats        = <span class="hljs-built_in">require</span>(<span class="hljs-string">'rolling-stats'</span>)
<span class="hljs-keyword">var</span> makeuse      = <span class="hljs-built_in">require</span>(<span class="hljs-string">'use-plugin'</span>)
<span class="hljs-keyword">var</span> lrucache     = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lru-cache'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Internal modules</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Entity       = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./entity'</span>).Entity
<span class="hljs-keyword">var</span> store        = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./store'</span>)
<span class="hljs-keyword">var</span> logging      = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./logging'</span>)
<span class="hljs-keyword">var</span> executor     = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./executor'</span>)
<span class="hljs-keyword">var</span> makeoptioner = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./optioner'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Utility functions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> common   = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./common'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Abbreviations</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> arr = common.arrayify</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Exports.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>module.exports = init</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Create a new Seneca instance.</p>
<ul>
<li>$     &rarr;  private context</li>
<li>opts  &rarr;  options</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">make_seneca</span><span class="hljs-params">($, initial_options )</span> {</span>
  <span class="hljs-comment">/* jshint validthis:true */</span>

  initial_options = initial_options || {}</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Seneca is an EventEmitter.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Seneca</span><span class="hljs-params">()</span> {</span>
    events.EventEmitter.call(<span class="hljs-keyword">this</span>)
  }
  util.inherits(Seneca, events.EventEmitter)

  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">new</span> Seneca()</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Expose the current version of Seneca</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  self.version = VERSION</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <h3 id="seneca-add">seneca.add</h3>
<p>Add an message pattern and action function.</p>
<p><code>seneca.add( pattern, action )</code>  </p>
<ul>
<li><em>pattern</em> (object or string)  &rarr;  pattern definition</li>
<li><em>action</em> (function)           &rarr;  function executed when input to <code>seneca.act</code> matches pattern</li>
</ul>
<p><code>seneca.add( pattern_string, pattern_object, action )</code>  </p>
<ul>
<li><em>pattern_string</em> (string)  &rarr;  pattern definition as jsonic string  </li>
<li><em>pattern_object</em> (object)  &rarr;  pattern definition as object  </li>
<li><em>action</em> (function)        &rarr;  function executed when input to <code>seneca.act</code> matches pattern.  </li>
</ul>
<p>The pattern is defined by the top level properties of the <em>pattern</em> parameter.
In the case where the pattern is a string, it is first parsed by <a href="https://github.com/rjrodger/jsonic">jsonic</a></p>
<p>If the value of a pattern property is a sub-object, this is interpreted as a 
<a href="https://github.com/rjrodger/parambulator">parambulator</a> validation check. In this case, the property
is not considered part of the pattern, but rather an argument to validate when <em>seneca.act</em> is called.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  self.add = api_add


  self.sub = api_sub


  self.logroute   = api_logroute
  self.register   = api_register
  self.depends    = api_depends
  self.export     = api_export

  self.make       = api_make
  self.make$      = api_make
  self.listen     = api_listen
  self.client     = api_client
  self.cluster    = api_cluster
  self.hasplugin  = api_hasplugin
  self.findplugin = api_findplugin
  self.pin        = api_pin
  self.declare    = api_declare

  self.findact    = api_findact

  self.has        = api_hasact
  self.hasact     = api_hasact

  self.actroutes  = api_actroutes
  self.list       = api_list
  self.act        = api_act
  self.act_if     = api_act_if
  self.wrap       = api_wrap
  self.close      = api_close
  self.ready      = api_ready
  self.use        = api_use
  self.seneca     = api_seneca
  self.fix        = api_fix
  self.delegate   = api_delegate

  self.options    = api_options


  <span class="hljs-keyword">var</span> argv = minimist(process.argv.slice(<span class="hljs-number">2</span>))</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Resolve options.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> optioner = $.optioner = makeoptioner( argv, initial_options.module || module.parent || module )
  <span class="hljs-keyword">delete</span> initial_options.module <span class="hljs-comment">// not need after this point, and screws up debug printing</span>

  <span class="hljs-keyword">var</span> so = optioner.set( initial_options )</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Identifier generator.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  self.idgen = nid({length:so.idlen})</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Create a unique identifer for this instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  self.id = self.idgen()+<span class="hljs-string">'/'</span>+<span class="hljs-built_in">Date</span>.now()+<span class="hljs-string">'/'</span>+so.tag

  self.name = <span class="hljs-string">'Seneca/'</span>+self.version+<span class="hljs-string">'/'</span>+self.id</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Set up logging.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>( so.test &amp;&amp; so.test.silent ) {
    so.log = <span class="hljs-string">'silent'</span>
  }

  $.logrouter = logging.makelogrouter(so.log)

  self.log = logging.makelog($.logrouter,self.id)</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>TODO: support options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $.executor = executor({
    trace:   _.isFunction(so.trace.act) ? so.trace.act : 
      (!!so.trace.act) ? make_trace_act({stack:so.trace.stack}) : <span class="hljs-literal">false</span>,
    timeout: so.timeout,
    error: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
      <span class="hljs-keyword">if</span>( !err ) <span class="hljs-keyword">return</span>;

      err.details        = err.details || {}
      err.details.plugin = err.details.plugin || {}

      self.log.error( <span class="hljs-string">'act'</span>,
                      err.details.plugin.name || <span class="hljs-string">'-'</span>,
                      err.details.plugin.tag || <span class="hljs-string">'-'</span>,
                      err.details.id,
                      err.message,
                      err.code,
                      err.details.pattern || <span class="hljs-string">'-'</span>, 
                      common.descdata(err.details),
                      err.stack )
    }
  })</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>TODO: encapsulate
setup status log</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>( <span class="hljs-number">0</span> &lt; so.status_interval &amp;&amp; so.status_log ) {
    $.stats = $.stats || {}
    setInterval(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">var</span> stats = {alive:(<span class="hljs-built_in">Date</span>.now()-$.stats.start),act:$.stats.act}
      self.log.info(<span class="hljs-string">'status'</span>,stats)
    },so.status_interval)
  }

  <span class="hljs-keyword">if</span>( so.stats ) {
    $.timestats = <span class="hljs-keyword">new</span> stats.NamedStats( so.stats.size, so.stats.duration )

    <span class="hljs-keyword">if</span>( so.stats.running ) {
      setInterval(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        $.timestats.calculate()
      }, so.stats.duration )
    }
  }


  $.plugins      = {}
  $.exports      = { options: common.deepextend({},so) }
  $.actrouter    = patrun()
  $.plugin_order = { byname:[], byref:[] }
  $.use          = makeuse( {prefix:<span class="hljs-string">'seneca-'</span>, module:module, msgprefix:<span class="hljs-literal">false</span>} )
  $.actcache     = lrucache({max:so.actcache_size})</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>prevent process exit</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  self.on(<span class="hljs-string">'error'</span>,common.noop) 


  self.toString = api_toString


  self.fail = makefail( self, {type:<span class="hljs-string">'sys'</span>,plugin:<span class="hljs-string">'seneca'</span>,tag:self.version,id:self.id} )


  self.util = {
    deepextend: common.deepextend,
    recurse:    common.recurse,
    clean:      common.clean,
    copydata:   common.copydata,
    nil:        common.nil,
    argprops:   common.argprops,
    print:      common.print,

    router:     <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span> <span class="hljs-keyword">return</span> patrun() },
    parsecanon: Entity.parsecanon,
  }


  self.store = {
    init: store.init,
    cmds: store.cmds
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>say hello, printing identifier to log</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  self.log.info(<span class="hljs-string">'hello'</span>,self.toString())</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>dump options if debugging</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  self.log.debug('options',function() {return util.inspect(so,false,null).replace(/[\r\n]/g,' ')})


  function api_logroute(entry,handler) {
    if( 0 === arguments.length ) return $.logrouter.toString()

    entry.handler = handler || entry.handler
    logging.makelogroute(entry,$.logrouter)
  }



  function paramerr(code) {
    return function(cb) {
      return function(err) { 
        if(err) {
          throw self.fail(code,{message:err.message})
        }
        else if( cb ) { 
          return cb();
        }
      }
    }
  }

  var paramcheck = {}

  paramcheck.register = parambulator({
    type$:     'object',
    required$: ['name','init'],
    string$:   ['name'],
    function$: ['init','service'],
    object$:   ['options']
  },{
    topname:'plugin',
    msgprefix:'register(plugin): ',
    callbackmaker:paramerr('register_invalid_plugin')
  })</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>TODO: remove cbfunc - this is hiding errors! log them instead</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_register</span><span class="hljs-params">( plugin, cbfunc )</span> {</span>
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    cbfunc = _.isFunction(cbfunc) ? cbfunc : common.noop
    paramcheck.register.validate(plugin)

    <span class="hljs-keyword">var</span> fullname = plugin.name+(plugin.tag?<span class="hljs-string">'/'</span>+plugin.tag:<span class="hljs-string">''</span>)
    <span class="hljs-keyword">var</span> tag      = plugin.tag||<span class="hljs-string">'-'</span>
    <span class="hljs-keyword">var</span> nameref  = [plugin.name,tag]

    plugin.fullname = fullname
    <span class="hljs-keyword">var</span> sd = make_plugin_delegate( self, plugin, {tag:tag,nameref:nameref} )


    self.log.debug(<span class="hljs-string">'register'</span>,<span class="hljs-string">'init'</span>,fullname)
    
    do_init( resolve_options(fullname,plugin) )


    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resolve_options</span><span class="hljs-params">( fullname, plugin )</span> {</span>
      so.plugin = so.plugin || {}
      <span class="hljs-keyword">var</span> fullname_options  = _.extend({},so[fullname],so.plugin[fullname])
      
      <span class="hljs-keyword">var</span> shortname = fullname != plugin.name ? plugin.name : <span class="hljs-literal">null</span>
      <span class="hljs-keyword">if</span>( !shortname &amp;&amp; <span class="hljs-number">0</span> === fullname.indexOf(<span class="hljs-string">'seneca-'</span>) ) {
        shortname = fullname.substring(<span class="hljs-string">'seneca-'</span>.length)
      }

      <span class="hljs-keyword">var</span> shortname_options = _.extend({},so[shortname],so.plugin[shortname])

      <span class="hljs-keyword">var</span> outopts = _.extend( {},
                              shortname_options,
                              fullname_options,
                              plugin.options || {} )

      <span class="hljs-keyword">return</span> outopts
    }


    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">do_init</span><span class="hljs-params">( options )</span> {</span>
      <span class="hljs-keyword">var</span> args = [options,install_plugin]</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>legacy plugins with function(seneca,opts,cb)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>( <span class="hljs-number">3</span> == plugin.init.length ) {
        args.unshift(sd)
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>single action convenience</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>( <span class="hljs-keyword">void</span> <span class="hljs-number">0</span> != plugin.init.pattern ) {
        <span class="hljs-keyword">var</span> action = plugin.init
        plugin.init = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
          <span class="hljs-keyword">this</span>.add(action.pattern,action)
        }
      }
      

      <span class="hljs-keyword">var</span> meta = plugin.init.apply(sd,args)

      meta = (plugin.init.length &lt;= <span class="hljs-number">1</span> &amp;&amp; <span class="hljs-keyword">void</span> <span class="hljs-number">0</span> == meta) ? {} : ( meta || {} )
      meta = _.isString( meta ) ? {name:meta} : meta

      meta.options = meta.options || options</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>TODO: merge options back into main options, under plugin name key
that way you can access them via exports and role:options, cmd:get</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
      <span class="hljs-keyword">var</span> updated_options = {}
      updated_options[fullname] = meta.options
      self.options( updated_options )

      <span class="hljs-keyword">return</span> install_plugin(<span class="hljs-literal">null</span>,meta)
    }


    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">install_plugin</span><span class="hljs-params">(err,meta)</span> {</span>
      <span class="hljs-keyword">if</span>( err ) {
        <span class="hljs-keyword">return</span> cbfunc(err);
      }

      meta = meta || {}</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>legacy api for service function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>( _.isFunction(meta) ) {
        meta = {service:meta}
      }

      plugin.name    = meta.name    || plugin.name
      plugin.tag     = meta.tag     || plugin.tag || (plugin.options &amp;&amp; plugin.options.tag$)
      plugin.service = meta.service || plugin.service

      nameref[<span class="hljs-number">0</span>]=plugin.name
      nameref[<span class="hljs-number">1</span>]=plugin.tag</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>name may have been changed by return value from plugin init</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
      <span class="hljs-keyword">var</span> pluginref = plugin.name+(plugin.tag?<span class="hljs-string">'/'</span>+plugin.tag:<span class="hljs-string">''</span>)
      $.plugins[pluginref] = plugin

      $.plugin_order.byname.push(plugin.name)
      $.plugin_order.byname = _.uniq($.plugin_order.byname)

      $.plugin_order.byref.push(pluginref)</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>LEGACY</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> service = plugin.service
      <span class="hljs-keyword">if</span>( service ) {
        service.log = sd.log
        service.key = pluginref
        self.act(<span class="hljs-string">'role:web'</span>,{use:service})
      }


      <span class="hljs-keyword">if</span>( !plugin.declare ) {
        self.act({init:plugin.name,tag:plugin.tag,<span class="hljs-keyword">default</span>$:{},gate$:<span class="hljs-literal">true</span>},<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err,out)</span> {</span>
          <span class="hljs-keyword">if</span>( err ) {
            <span class="hljs-keyword">return</span> self.die(<span class="hljs-string">'plugin_init'</span>,err,plugin)
          }
          <span class="hljs-keyword">return</span> self.log.debug(<span class="hljs-string">'register'</span>,<span class="hljs-string">'ready'</span>,pluginref,out)
        })
      }

      <span class="hljs-keyword">var</span> exports = []
      
      <span class="hljs-keyword">if</span>( <span class="hljs-keyword">void</span> <span class="hljs-number">0</span> != meta.export ) {
        $.exports[pluginref] = meta.export
        exports.push(pluginref)
      }

      <span class="hljs-keyword">if</span>( _.isObject(meta.exportmap) || _.isObject(meta.exports) ) {
        meta.exportmap = meta.exportmap || meta.exports
        _.each(meta.exportmap,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v,k)</span> {</span>
          <span class="hljs-keyword">if</span>( <span class="hljs-keyword">void</span> <span class="hljs-number">0</span> != v ) {
            <span class="hljs-keyword">var</span> exportname = pluginref+<span class="hljs-string">'/'</span>+k
            $.exports[exportname] = v
            exports.push(exportname)
          }
        })
      }

      self.log.debug(<span class="hljs-string">'register'</span>,<span class="hljs-string">'install'</span>,pluginref,{exports:exports},fullname!=pluginref?fullname:<span class="hljs-literal">undefined</span>)

      cbfunc(<span class="hljs-literal">null</span>)
    }
  }



  
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_depends</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> args = norma(<span class="hljs-string">'{pluginname:s deps:a? moredeps:s*}'</span>,<span class="hljs-built_in">arguments</span>)
    
    <span class="hljs-keyword">var</span> deps = args.deps || args.moredeps

    _.every(deps, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(depname)</span> {</span>
      <span class="hljs-keyword">if</span>( !_.contains($.plugin_order.byname,depname) &amp;&amp;
          !_.contains($.plugin_order.byname,<span class="hljs-string">'seneca-'</span>+depname) ) {
        self.die(<span class="hljs-string">'plugin_required'</span>,{name:args.pluginname,dependency:depname})
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    })
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_export</span><span class="hljs-params">( key )</span> {</span>
    <span class="hljs-keyword">var</span> exportval = $.exports[key];
    <span class="hljs-keyword">if</span>( !exportval ) {
      <span class="hljs-keyword">return</span> self.die( <span class="hljs-string">'export_not_found'</span>, {key:key} )
    }
    
    <span class="hljs-keyword">return</span> exportval;
  }


  self.die = makedie( self, {type:<span class="hljs-string">'sys'</span>,plugin:<span class="hljs-string">'seneca'</span>,tag:self.version,id:self.id} )</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>all optional</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_make</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> args = arr(<span class="hljs-built_in">arguments</span>)
    <span class="hljs-keyword">var</span> si = (<span class="hljs-keyword">this</span> &amp;&amp; <span class="hljs-keyword">this</span>.seneca) ? <span class="hljs-keyword">this</span> : self
    args.unshift(si)
    <span class="hljs-keyword">return</span> $.entity.make$.apply($.entity,args)
  }
  self.make$ = self.make




  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_listen</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">var</span> config = arr(<span class="hljs-built_in">arguments</span>)

    self.act(<span class="hljs-string">'role:transport,cmd:listen'</span>,{config:config,gate$:<span class="hljs-literal">true</span>},<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
      <span class="hljs-keyword">if</span>( err ) <span class="hljs-keyword">return</span> self.die(<span class="hljs-string">'transport_listen'</span>,err,config)
    })

    <span class="hljs-keyword">return</span> self
  }




  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_client</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> config = arr(<span class="hljs-built_in">arguments</span>)

    <span class="hljs-keyword">var</span> findact = _.bind(self.findact,self)</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>WARNING!!!!
A horrible, temporary hack so that .act calls after a .client will work
without needing .ready
SOLUTION: api_act should insert entire action performance into executor,
including findact call
REFACTOR REFACTOR REFACTOR</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    self.findact = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( args )</span> {</span>
      <span class="hljs-keyword">var</span> actmeta = findact( args )
      <span class="hljs-keyword">if</span>( actmeta ) <span class="hljs-keyword">return</span> actmeta;

      actmeta = {
        func: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(args,done)</span> {</span> 
          <span class="hljs-keyword">var</span> seneca = <span class="hljs-keyword">this</span>

          <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkready</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> am = seneca.findact(args)
            <span class="hljs-keyword">if</span>( am.client$ ) {
              am.func.call(seneca,args,done)
            }
            <span class="hljs-keyword">else</span> {
              setTimeout(checkready,<span class="hljs-number">55</span>)
            }
          }
          checkready()

        },
        plugin_nameref:<span class="hljs-string">'-'</span>,
        log:self.log,
        argpattern:common.owndesc(args),
        id:<span class="hljs-string">'CLIENT'</span>
      }

      <span class="hljs-keyword">return</span> actmeta
    }


    self.act( 
      <span class="hljs-string">'role:transport,cmd:client'</span>,
      {config:config,gate$:<span class="hljs-literal">true</span>},
      <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err,sendclient)</span> {</span>
        <span class="hljs-keyword">if</span>( err ) <span class="hljs-keyword">return</span> self.die(<span class="hljs-string">'transport_client'</span>,err,config)
        <span class="hljs-keyword">if</span>( <span class="hljs-literal">null</span> == sendclient ) <span class="hljs-keyword">return</span> self.die(<span class="hljs-string">'transport_client_null'</span>,config)

        self.findact = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( args )</span> {</span>
          <span class="hljs-keyword">if</span>( !sendclient.match.call( self, args ) ) {
            <span class="hljs-keyword">return</span> findact( args )
          }

          <span class="hljs-keyword">var</span> actmeta = {
            func: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(args,done)</span> {</span> 
              <span class="hljs-keyword">try</span> {
                sendclient.send.call( self, args, done ) 
              }
              <span class="hljs-keyword">catch</span>( e ) { 
                done(e) 
              }
            },
            plugin_nameref:<span class="hljs-string">'-'</span>,
            log:self.log,
            argpattern:common.owndesc(args),
            id:<span class="hljs-string">'CLIENT'</span>,
            client$:<span class="hljs-literal">true</span>
          }

          <span class="hljs-keyword">return</span> actmeta
        }
      })


    <span class="hljs-keyword">return</span> self
  }




  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_cluster</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-comment">/* jshint loopfunc:true */</span>
    <span class="hljs-keyword">var</span> cluster = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cluster'</span>)

    <span class="hljs-keyword">if</span>( cluster.isMaster ) {
      <span class="hljs-built_in">require</span>(<span class="hljs-string">'os'</span>).cpus().forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        cluster.fork()
      })

      cluster.on(<span class="hljs-string">'disconnect'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(worker)</span> {</span>
        cluster.fork()
      })

      <span class="hljs-keyword">var</span> noopinstance = self.delegate()
      <span class="hljs-keyword">for</span>( <span class="hljs-keyword">var</span> fn <span class="hljs-keyword">in</span> noopinstance ) {
        <span class="hljs-keyword">if</span>( _.isFunction(noopinstance[fn]) ) {
          noopinstance[fn] = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span> <span class="hljs-keyword">return</span> noopinstance; }
        }
      }

      <span class="hljs-keyword">return</span> noopinstance;
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> self;
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_hasplugin</span><span class="hljs-params">(plugindesc,tag)</span> {</span>
    <span class="hljs-keyword">return</span> !!self.findplugin(plugindesc,tag)
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>get plugin instance</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_findplugin</span><span class="hljs-params">(plugindesc,tag)</span> {</span>
    <span class="hljs-keyword">var</span> name = plugindesc.name || plugindesc
    tag = plugindesc.tag || tag

    <span class="hljs-keyword">var</span> key = name+(tag?<span class="hljs-string">'/'</span>+tag:<span class="hljs-string">''</span>)
    <span class="hljs-keyword">var</span> plugin = $.plugins[key]

    <span class="hljs-keyword">return</span> plugin
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_pin</span><span class="hljs-params">( pattern, pinopts )</span> {</span>
    <span class="hljs-keyword">var</span> thispin = <span class="hljs-keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>console.log(‘api_pin’,thispin.fixedargs)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">var</span> methodkeys = []
    <span class="hljs-keyword">for</span>( <span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> pattern ) {
      <span class="hljs-keyword">if</span>( <span class="hljs-regexp">/[\*\?]/</span>.exec(pattern[key]) ) {
        methodkeys.push(key)
      }
    }


    <span class="hljs-keyword">var</span> methods = $.actrouter.list(pattern)


    <span class="hljs-keyword">var</span> api = {toString:<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span><span class="hljs-keyword">return</span> <span class="hljs-string">'pin:'</span>+common.descdata(pattern,<span class="hljs-number">1</span>)+<span class="hljs-string">'/'</span>+thispin}}

    methods.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(method)</span> {</span>
      <span class="hljs-keyword">var</span> mpat = method.match

      <span class="hljs-keyword">var</span> methodname = <span class="hljs-string">''</span>
      <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> mkI = <span class="hljs-number">0</span>; mkI &lt; methodkeys.length; mkI++) {
        methodname += ((<span class="hljs-number">0</span>&lt;mkI?<span class="hljs-string">'_'</span>:<span class="hljs-string">''</span>)) + mpat[methodkeys[mkI]]
      }

      api[methodname] = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(args,cb)</span> {</span>
        <span class="hljs-keyword">var</span> si = <span class="hljs-keyword">this</span> &amp;&amp; <span class="hljs-keyword">this</span>.seneca ? <span class="hljs-keyword">this</span> : thispin</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>console.log(‘api call’,si.fixedargs)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        <span class="hljs-keyword">var</span> fullargs = _.extend({},args,mpat)
        si.act.call(si,fullargs,cb)
      }

      api[methodname].pattern$ = method.match
      api[methodname].name$    = methodname
    })

    <span class="hljs-keyword">if</span>( pinopts ) {
      <span class="hljs-keyword">if</span>( pinopts.include ) {
        <span class="hljs-keyword">for</span>( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; pinopts.include.length; i++ ) {
          <span class="hljs-keyword">var</span> methodname = pinopts.include[i]
          <span class="hljs-keyword">if</span>( thispin[methodname] ) {
            api[methodname] = common.delegate(thispin,thispin[methodname])
          }
        }
      }
    }

    <span class="hljs-keyword">return</span> api
  }


  <span class="hljs-keyword">var</span> pm_custom_args = {
    rules: {
      entity$: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(ctxt,cb)</span> {</span>
        <span class="hljs-keyword">var</span> val = ctxt.point
        <span class="hljs-keyword">if</span>( val.entity$ ) {
          <span class="hljs-keyword">if</span>( val.canon$({isa:ctxt.rule.spec}) ) {
            <span class="hljs-keyword">return</span> cb();
          }
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> ctxt.util.fail(ctxt,cb);
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> ctxt.util.fail(ctxt,cb);
      }
    },
    msgs: {
      entity$: <span class="hljs-string">'The value &lt;%=value%&gt; is not a data entity of kind &lt;%=rule.spec%&gt; (property &lt;%=parentpath%&gt;).'</span>
    }
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_sub</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">var</span> subargs = parse_pattern(self,<span class="hljs-built_in">arguments</span>,<span class="hljs-string">'action:f actmeta:o?'</span>)
    subargs.pattern.sub$ = <span class="hljs-literal">true</span>

    <span class="hljs-keyword">return</span> api_add.call(self,subargs.pattern,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(args,done)</span> {</span>
      subargs.action.call(<span class="hljs-keyword">this</span>,args)
      <span class="hljs-keyword">this</span>.prior(args,done)
    },subargs.actmeta)
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>params: argstr,argobj,actfunc,actmeta</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_add</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> args = parse_pattern(self,<span class="hljs-built_in">arguments</span>,<span class="hljs-string">'action:f actmeta:o?'</span>)

    <span class="hljs-keyword">var</span> pattern   = args.pattern
    <span class="hljs-keyword">var</span> action    = args.action
    <span class="hljs-keyword">var</span> actmeta   = args.actmeta || {}

    actmeta.sub = !!pattern.sub$

    pattern = self.util.clean(args.pattern)

    <span class="hljs-keyword">if</span>( <span class="hljs-number">0</span> === _.keys( pattern ) ) {
      <span class="hljs-keyword">throw</span> self.fail(<span class="hljs-string">'add_empty_pattern'</span>,{args:args})
    }


    <span class="hljs-keyword">var</span> pattern_rules = {}
    _.each( pattern, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v,k)</span> {</span> 
      <span class="hljs-keyword">if</span>( _.isObject(v) ) {
        pattern_rules[k] = v
        <span class="hljs-keyword">delete</span> pattern[k]
      }
    })
    
    <span class="hljs-keyword">if</span>( <span class="hljs-number">0</span> &lt; _.keys(pattern_rules).length ) {
      actmeta.parambulator = parambulator(pattern_rules, pm_custom_args)
    }

    <span class="hljs-keyword">var</span> addroute  = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">var</span> priormeta = self.findact( pattern )

    actmeta.args = _.clone( pattern )
    actmeta.argpattern = common.owndesc( pattern )
    actmeta.id = self.idgen()



    actmeta.func = action

    <span class="hljs-keyword">if</span>( priormeta ) {
      <span class="hljs-keyword">if</span>( _.isFunction(priormeta.handle) ) {
        priormeta.handle(action)
        addroute = <span class="hljs-literal">false</span>
      }
      <span class="hljs-keyword">else</span> { 
        actmeta.priormeta = priormeta 
      }
      actmeta.priorpath = priormeta.id+<span class="hljs-string">';'</span>+priormeta.priorpath
    }
    <span class="hljs-keyword">else</span> {
      actmeta.priorpath = <span class="hljs-string">''</span>
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>FIX: need a much better way to support layered actions
this “.handle” hack is just to make seneca.close work</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>( action &amp;&amp; actmeta &amp;&amp; _.isFunction(action.handle) ) {
      actmeta.handle = action.handle
    }


    $.stats.actmap[actmeta.argpattern] = 
      $.stats.actmap[actmeta.argpattern] || 
      {id:actmeta.id,
       plugin:{full:actmeta.plugin_fullname,name:actmeta.plugin_nameref,tag:actmeta.plugin_tag},
       prior:actmeta.priorpath,calls:<span class="hljs-number">0</span>,done:<span class="hljs-number">0</span>,fails:<span class="hljs-number">0</span>,time:{}}
    
    <span class="hljs-keyword">if</span>( addroute ) {
      <span class="hljs-keyword">var</span> plugin_name = (actmeta.plugin_nameref &amp;&amp; actmeta.plugin_nameref[<span class="hljs-number">0</span>]) || <span class="hljs-string">'-'</span> 
      <span class="hljs-keyword">var</span> plugin_tag  = (actmeta.plugin_nameref &amp;&amp; actmeta.plugin_nameref[<span class="hljs-number">1</span>]) || <span class="hljs-string">'-'</span> 

      self.log.debug(
        actmeta.sub ? <span class="hljs-string">'sub'</span> : <span class="hljs-string">'add'</span>,
        plugin_name,plugin_tag,pattern,actmeta.id)

      $.actrouter.add(pattern,actmeta)
    }

    <span class="hljs-keyword">return</span> self
  }
  


  self.compose = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(args,acts)</span> {</span>
    self.add(args,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(call_args,cb)</span> {</span>
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">call_act</span><span class="hljs-params">(i,cur_args)</span> {</span>
        <span class="hljs-keyword">if</span>( i &lt; acts.length ) {
          cur_args = _.omit(cur_args,_.keys(acts[i-<span class="hljs-number">1</span>]||args))
          cur_args = _.extend(cur_args,acts[i])

          self.act(cur_args,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err,next_args)</span> {</span>
            <span class="hljs-keyword">if</span>( err ) <span class="hljs-keyword">return</span> cb(err);
            next_args = acts[i].modify$ ? (acts[i].modify$(next_args,call_args)||next_args) : next_args
            call_act(i+<span class="hljs-number">1</span>,next_args)
          })
        }
        <span class="hljs-keyword">else</span> cb(<span class="hljs-literal">null</span>,cur_args)
      }
      call_act(<span class="hljs-number">0</span>,call_args)
    })
  }


  
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_findact</span><span class="hljs-params">(args)</span> {</span>
    <span class="hljs-keyword">var</span> actmeta = $.actrouter.find(args)
    <span class="hljs-keyword">return</span> actmeta
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_hasact</span><span class="hljs-params">(args)</span> {</span>
    <span class="hljs-keyword">return</span> !!$.actrouter.find(args)
  }



  self.findpins = self.pinact = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> pins = []
    <span class="hljs-keyword">var</span> patterns = _.flatten(arr(<span class="hljs-built_in">arguments</span>))
    _.each( patterns, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(pattern)</span> {</span>
      pattern = _.isString(pattern) ? jsonic(pattern) : pattern
      pins = pins.concat( _.map( $.actrouter.list(pattern), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(desc)</span> {</span><span class="hljs-keyword">return</span> desc.match} ) )
    })
    <span class="hljs-keyword">return</span> pins
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_actroutes</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> $.actrouter.toString(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d)</span> {</span>
      <span class="hljs-keyword">var</span> s = <span class="hljs-string">'F='</span>

      <span class="hljs-keyword">if</span>( d.plugin_fullname ) {
        s+=d.plugin_fullname+<span class="hljs-string">'/'</span>
      }

      s+=d.id

      <span class="hljs-keyword">while</span>( d.priormeta ) {
        d = d.priormeta
        s+=<span class="hljs-string">';'</span>

        <span class="hljs-keyword">if</span>( d.plugin_fullname ) {
          s+=d.plugin_fullname+<span class="hljs-string">'/'</span>
        }

        s+=d.id

      }
      <span class="hljs-keyword">return</span> s
    })
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_list</span><span class="hljs-params">( args )</span> {</span>
    <span class="hljs-keyword">var</span> found = $.actrouter.list( args )
    
    found = _.map( found, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(entry)</span> {</span>
      <span class="hljs-keyword">return</span> entry.match
    })
    <span class="hljs-keyword">return</span> found
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle_act_args</span><span class="hljs-params">(self,orig)</span> {</span>
    <span class="hljs-keyword">var</span> args = parse_pattern( self, orig, <span class="hljs-string">'done:f?'</span> )
    <span class="hljs-keyword">var</span> done = args.done ? args.done : common.noop

    <span class="hljs-keyword">return</span> [args.pattern,done]
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_act_if</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> args = norma(<span class="hljs-string">'{execute:b actargs:.*}'</span>,<span class="hljs-built_in">arguments</span>)

    <span class="hljs-keyword">if</span>( args.execute ) {
      <span class="hljs-keyword">return</span> self.act.apply( self, args.actargs )
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> self;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Perform an action. The propeties of the first argument are matched against 
known patterns, and the most specific one wins.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_act</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">var</span> argscb = handle_act_args(self,arr(<span class="hljs-built_in">arguments</span>))
    <span class="hljs-keyword">var</span> args = argscb[<span class="hljs-number">0</span>]
    <span class="hljs-keyword">var</span> cb   = argscb[<span class="hljs-number">1</span>]

    <span class="hljs-keyword">var</span> actmeta = self.findact(args)

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">provide_default</span><span class="hljs-params">()</span> {</span>
      self.log.debug(<span class="hljs-string">'act'</span>,<span class="hljs-string">'-'</span>,<span class="hljs-string">'-'</span>,<span class="hljs-string">'-'</span>,<span class="hljs-string">'DEFAULT'</span>,self.util.clean(args))
      cb.call(self,<span class="hljs-literal">null</span>,args.default$);
    }

    <span class="hljs-keyword">if</span>( !actmeta ) {
      <span class="hljs-keyword">if</span>( _.isUndefined(args.default$) ) {
        <span class="hljs-keyword">var</span> err = self.fail(<span class="hljs-string">'act_not_found'</span>,{args:args})

        err.details = err.details || {}
        err.details.plugin = err.details.plugin || {}

        self.log.error(<span class="hljs-string">'act'</span>,
                       err.details.plugin.name || <span class="hljs-string">'-'</span>,
                       err.details.plugin.tag || <span class="hljs-string">'-'</span>,
                       err.details.id,
                       err.message,
                       err.code,
                       err.details ? err.details.pattern : <span class="hljs-string">'-'</span>, 
                       common.descdata(err.details),
                       err.stack )

        <span class="hljs-keyword">return</span> cb( err )
      }
      <span class="hljs-keyword">else</span> provide_default()
    }
    <span class="hljs-keyword">else</span> do_act(self,actmeta,<span class="hljs-literal">false</span>,args,cb)

    <span class="hljs-keyword">return</span> self
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>TODO: just use var self = this</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_wrap</span><span class="hljs-params">(pin,wrapper)</span> {</span>
    <span class="hljs-keyword">var</span> pinthis = <span class="hljs-keyword">this</span> || self

    <span class="hljs-keyword">if</span>( _.isArray(pin) ) {
      _.each(pin, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p)</span> {</span>
        do_wrap(p)
      })
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> do_wrap(pin);

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">do_wrap</span><span class="hljs-params">( pin )</span> {</span>
      _.each( pinthis.pinact(pin), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(actpattern)</span> {</span>
        pinthis.add(actpattern,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(args,done)</span> {</span>
          wrapper.call(<span class="hljs-keyword">this</span>,args,done)
        })
      })
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>close seneca instance
sets public seneca.closed property</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_close</span><span class="hljs-params">(done)</span> {</span>
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
    
    self.closed = <span class="hljs-literal">true</span>

    self.log.debug(<span class="hljs-string">'close'</span>,<span class="hljs-string">'start'</span>)
    self.act(<span class="hljs-string">'role:seneca,cmd:close'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
      <span class="hljs-keyword">this</span>.log.debug(<span class="hljs-string">'close'</span>,<span class="hljs-string">'end'</span>,err)
      <span class="hljs-keyword">if</span>( _.isFunction(done) ) <span class="hljs-keyword">return</span> done.call(<span class="hljs-keyword">this</span>,err);
    })
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>useful when defining services!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_ready</span><span class="hljs-params">(ready)</span> {</span>
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">if</span>( _.isFunction(ready) ) {
      self.act(<span class="hljs-string">'role:seneca,ready:true,gate$:true'</span>,ready)
    }

    <span class="hljs-keyword">return</span> self;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>use(‘pluginname’) - built-in, or provide calling code ‘require’ as seneca opt
use( require(‘pluginname’) ) - plugin object, init will be called
if first arg has property senecaplugin </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_use</span><span class="hljs-params">( arg0, arg1, arg2 )</span> {</span>
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Legacy options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>( <span class="hljs-string">'options'</span> == arg0 ) {
      self.options( arg1 )
      <span class="hljs-keyword">return</span> self
    }


    <span class="hljs-keyword">var</span> plugindesc

    <span class="hljs-keyword">try</span> {
      plugindesc = $.use( arg0, arg1, arg2 )
    }
    <span class="hljs-keyword">catch</span>(e) {
      <span class="hljs-keyword">return</span> self.die( <span class="hljs-string">'plugin_'</span>+e.code, e );
    }

    self.register( plugindesc, plugindesc.callback )

    <span class="hljs-keyword">return</span> self
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>TODO: remove, not needed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_declare</span><span class="hljs-params">( arg0, arg1, arg2 )</span> {</span>
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">var</span> plugindesc

    <span class="hljs-keyword">try</span> {
      plugindesc = $.use( arg0, arg1, arg2 )
    }
    <span class="hljs-keyword">catch</span>(e) {
      <span class="hljs-keyword">if</span>( e.code ) {
        <span class="hljs-keyword">return</span> self.die( <span class="hljs-string">'plugin_'</span>+e.code, e.details )
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">throw</span> e;
    }

    plugindesc.declare = <span class="hljs-literal">true</span>
    self.register( plugindesc, plugindesc.callback )

    <span class="hljs-keyword">return</span> self
  }


  self.inrepl = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    self.on(<span class="hljs-string">'act-out'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
      logging.handlers.print.apply(<span class="hljs-literal">null</span>,arr(<span class="hljs-built_in">arguments</span>))
    })
    
    self.on(<span class="hljs-string">'error'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
      <span class="hljs-keyword">var</span> args = arr(<span class="hljs-built_in">arguments</span>).slice()
      args.unshift(<span class="hljs-string">'ERROR: '</span>)
      logging.handlers.print.apply(<span class="hljs-literal">null</span>,arr(args))
    })
  }


  self.startrepl = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(in_opts)</span> {</span>
    <span class="hljs-keyword">var</span> repl_opts = _.extend({repl:{listen:<span class="hljs-number">10170</span>}},so,in_opts)
    
    net.createServer(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(socket)</span> {</span>
      <span class="hljs-keyword">var</span> actout =  <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        socket.write(<span class="hljs-string">''</span>+arr(<span class="hljs-built_in">arguments</span>)+<span class="hljs-string">'\n'</span>)
      }
      
      <span class="hljs-keyword">var</span> r = repl.start({
        prompt: <span class="hljs-string">'seneca '</span>+socket.remoteAddress+<span class="hljs-string">':'</span>+socket.remotePort+<span class="hljs-string">'&gt; '</span>, 
        input: socket, output: socket, terminal: <span class="hljs-literal">true</span>, useGlobal: <span class="hljs-literal">false</span>
      })
      
      r.on(<span class="hljs-string">'exit'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
        self.removeListener(<span class="hljs-string">'act-out'</span>,actout)
        socket.end()
      })
      
      r.context.seneca = self.delegate()
      
      <span class="hljs-keyword">var</span> orig_act = r.context.seneca.act
      r.context.seneca.act = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">var</span> args = arr(<span class="hljs-built_in">arguments</span>)
        args.repl$=<span class="hljs-literal">true</span>
        orig_act.apply(self,args)
        <span class="hljs-keyword">return</span> r.context.seneca
      }

      self.on(<span class="hljs-string">'act-out'</span>,actout)
      
    }).listen(repl_opts.repl.listen)
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>/ Return self. Mostly useful as a check that this is a Seneca instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_seneca</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> self
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Describe this instance using the form: Seneca/VERSION/ID</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_toString</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.name
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">do_act</span><span class="hljs-params">(instance,actmeta,isprior,origargs,cb)</span> {</span>
    <span class="hljs-keyword">var</span> act_start = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime()

    <span class="hljs-keyword">var</span> args = _.clone(origargs)

    <span class="hljs-keyword">if</span>( <span class="hljs-literal">null</span> != args.actid$ ) {
      <span class="hljs-keyword">var</span> actdetails = $.actcache.get(args.actid$)      
      <span class="hljs-keyword">if</span>( actdetails ) {
        $.stats.act.cache++
        self.log.debug(<span class="hljs-string">'act'</span>,
                       actdetails.actmeta.plugin_nameref[<span class="hljs-number">0</span>]||<span class="hljs-string">'-'</span>,
                       actdetails.actmeta.plugin_nameref[<span class="hljs-number">1</span>]||<span class="hljs-string">'-'</span>,
                       args.actid$,<span class="hljs-string">'CACHE'</span>,
                       <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                         <span class="hljs-keyword">return</span> [actdetails.actmeta.descdata ? 
                                 actdetails.actmeta.descdata(args) : 
                                 common.descdata(args), actdetails.actmeta.id]
                       })

        <span class="hljs-keyword">return</span> cb.apply( instance, actdetails.result )
      }
    }


    <span class="hljs-keyword">var</span> actid = ( args.actid$ || self.idgen() )</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>FIX: make this error nice to handle for calling code - get rid of circular ref</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>( actmeta.parambulator ) {
      actmeta.parambulator.validate(args,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>

        <span class="hljs-keyword">if</span>( err ) {
          <span class="hljs-keyword">throw</span> instance.fail(<span class="hljs-string">'act_invalid_args'</span>,{message:err.message,args:origargs})
        }

        <span class="hljs-keyword">return</span> perform(actmeta)
      })
    } 
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> perform(actmeta);


    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">perform</span><span class="hljs-params">(actmeta)</span> {</span>
      <span class="hljs-keyword">var</span> actstats = ($.stats.actmap[actmeta.argpattern] = $.stats.actmap[actmeta.argpattern] || {})

      <span class="hljs-keyword">var</span> plugin_nameref = 
            (actmeta.plugin_nameref = (actmeta.plugin_nameref||[<span class="hljs-string">'-'</span>,<span class="hljs-string">'-'</span>]))

      <span class="hljs-keyword">var</span> do_log = !actmeta.sub

      <span class="hljs-keyword">if</span>( do_log ) {
        self.log.debug(<span class="hljs-string">'act'</span>,plugin_nameref[<span class="hljs-number">0</span>]||<span class="hljs-string">'-'</span>,plugin_nameref[<span class="hljs-number">1</span>]||<span class="hljs-string">'-'</span>,actid,<span class="hljs-string">'IN'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
          <span class="hljs-keyword">var</span> argmeta = args.gate$ ? <span class="hljs-string">'GATE'</span> : <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>
          argmeta = args.ungate$ ? 
            argmeta ? argmeta+<span class="hljs-string">';UNGATE'</span>:<span class="hljs-string">'UNGATE'</span> : argmeta || <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>
          <span class="hljs-keyword">return</span> [actmeta.descdata ? actmeta.descdata(args) : common.descdata(args),
                  actmeta.id, argmeta]
        })
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>TODO” review the way this works</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> delegate_args = {}
      <span class="hljs-keyword">if</span>( <span class="hljs-literal">null</span> != args.gate$ ) {
        delegate_args.ungate$ = !!args.gate$
      }
      <span class="hljs-keyword">var</span> delegate = instance.delegate( delegate_args )


      instance.emit(<span class="hljs-string">'act-in'</span>, actmeta.argpattern, actid, args)</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>automate actid log insertion</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      delegate.log = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">var</span> args = arr(<span class="hljs-built_in">arguments</span>)
        <span class="hljs-keyword">if</span>( _.isFunction(actmeta.log) ) {
          <span class="hljs-keyword">var</span> entries = [args[<span class="hljs-number">0</span>]].concat(actid).concat(args.slice(<span class="hljs-number">1</span>))
          actmeta.log.apply(instance,entries)
        }
        <span class="hljs-keyword">else</span> {
          instance.log.apply(instance,[args[<span class="hljs-number">0</span>]].concat([<span class="hljs-string">'single'</span>,<span class="hljs-string">'-'</span>,<span class="hljs-string">'-'</span>,actid]).concat(args.slice(<span class="hljs-number">1</span>)))
        }
      }
      logging.makelogfuncs(delegate)


      <span class="hljs-keyword">if</span>( actmeta.priormeta ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>TODO: deprecate parent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        delegate.prior = delegate.parent = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(args,cb)</span> {</span>
          do_act(delegate,actmeta.priormeta,<span class="hljs-literal">true</span>,args,cb)
        }
      }
      <span class="hljs-keyword">else</span> delegate.prior = common.nil


      <span class="hljs-keyword">var</span> callargs = args
      callargs.actid$ = actid</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>fixed args are not used for finding actions!!!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>( delegate.fixedargs ) {
        callargs = _.extend({},args,delegate.fixedargs)
      }
      
      $.stats.act.calls++
      actstats.calls++
      <span class="hljs-keyword">var</span> actstart = <span class="hljs-built_in">Date</span>.now()




      <span class="hljs-keyword">var</span> act_done = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
        <span class="hljs-keyword">var</span> actend = <span class="hljs-built_in">Date</span>.now()
        $.timestats.point( actend-actstart, actmeta.argpattern )

        <span class="hljs-keyword">var</span> result = arr(<span class="hljs-built_in">arguments</span>)

        $.actcache.set(actid,{result:result,actmeta:actmeta})


        <span class="hljs-keyword">if</span>( err ) {
          $.stats.act.fails++
          actstats.fails++

          err.details = err.details || {}
          err.details.plugin = err.details.plugin || {}

          self.log.error(<span class="hljs-string">'act'</span>,
                         err.details.plugin.name || <span class="hljs-string">'-'</span>,
                         err.details.plugin.tag || <span class="hljs-string">'-'</span>,
                         err.details.id,
                         err.message,
                         err.code,
                         err.details ? err.details.pattern : <span class="hljs-string">'-'</span>, 
                         common.descdata(err.details),
                         err.stack )

        }
        <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">var</span> emitresult = result.slice()
          emitresult.unshift(actid)
          emitresult.unshift(actmeta.argpattern)
          emitresult.unshift(<span class="hljs-string">'act-out'</span>)
          instance.emit.apply(instance,emitresult)
          
          result[<span class="hljs-number">0</span>] = <span class="hljs-literal">null</span>

          <span class="hljs-keyword">if</span>( do_log ) {
            self.log.debug(<span class="hljs-string">'act'</span>,plugin_nameref[<span class="hljs-number">0</span>]||<span class="hljs-string">'-'</span>,plugin_nameref[<span class="hljs-number">1</span>]||<span class="hljs-string">'-'</span>,actid,<span class="hljs-string">'OUT'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
              <span class="hljs-keyword">return</span> _.flatten( [ _.flatten([ actmeta.descdata ? actmeta.descdata(result.slice(<span class="hljs-number">1</span>)) : common.descdata(result.slice(<span class="hljs-number">1</span>)) ], <span class="hljs-literal">true</span>), actmeta.id ] )
            })
          }

          $.stats.act.done++
          actstats.done++
        }
        
        <span class="hljs-keyword">try</span> {
          cb.apply(delegate,result) <span class="hljs-comment">// note: err == result[0]</span>
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>for errors thrown inside the callback</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">catch</span>( er ) {
          <span class="hljs-keyword">var</span> error = er
          <span class="hljs-keyword">if</span>( error.seneca ) {
            error.seneca.callback = <span class="hljs-literal">true</span>
            <span class="hljs-keyword">throw</span> error;
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>handle throws of non-Error values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span>( !util.isError(error) ) {
            <span class="hljs-keyword">if</span>( _.isObject(error) ) {
              error = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(common.owndesc(error,<span class="hljs-number">1</span>))
            }
            <span class="hljs-keyword">else</span> {
              error = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">''</span>+error)
            }
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>TODO: not really satisfactory</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">var</span> err = instance.fail( error, {result:result} )
          self.log.error(<span class="hljs-string">'act'</span>,<span class="hljs-string">'err'</span>,actid, <span class="hljs-string">'callback'</span>, err.message, actmeta.id, origargs, error.stack )
        }
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>console.log(callargs)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      $.executor.execute({
        id:      actid,
        gate:    !!callargs.gate$,
        ungate:  !!callargs.ungate$,
        pattern: actmeta.argpattern,
        cb:      act_done,

        plugin: {
          name: actmeta.plugin_nameref ? actmeta.plugin_nameref[<span class="hljs-number">0</span>] : <span class="hljs-literal">undefined</span>,
          tag:  actmeta.plugin_nameref ? actmeta.plugin_nameref[<span class="hljs-number">1</span>] : <span class="hljs-literal">undefined</span>,
        },

        fn:<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cb)</span> {</span>
          delegate.good = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(out)</span> {</span>
            cb(<span class="hljs-literal">null</span>,out)
          }

          delegate.bad = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
            cb(err)
          }

          actmeta.func.call(delegate,callargs,cb)
        },
      })
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>string args override object args</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parse_pattern</span><span class="hljs-params">(instance,args,normaspec,fixed)</span> {</span>
    args = norma(<span class="hljs-string">'{strargs:s? objargs:o? '</span>+(normaspec||<span class="hljs-string">''</span>)+<span class="hljs-string">'}'</span>, args)

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">return</span> _.extend(
        args,
        { pattern: _.extend(
          args.objargs ? args.objargs : {},
          args.strargs ? jsonic( args.strargs ) : {},
          fixed || {} )
        })
    }
    <span class="hljs-keyword">catch</span>( e ) {
      <span class="hljs-keyword">var</span> col = <span class="hljs-number">1</span>==e.line?e.column-<span class="hljs-number">1</span>:e.column
      <span class="hljs-keyword">throw</span> instance.fail(<span class="hljs-string">'add_string_pattern_syntax'</span>,{argstr:args,syntax:e.message,line:e.line,col:col})
    }
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_fix</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">var</span> defargs = parse_pattern(self,<span class="hljs-built_in">arguments</span>)

    <span class="hljs-keyword">var</span> fix = self.delegate( defargs.pattern )

    fix.add = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">var</span> args    = parse_pattern(fix,<span class="hljs-built_in">arguments</span>,<span class="hljs-string">'rest:.*'</span>,defargs.pattern)
      <span class="hljs-keyword">var</span> addargs = [args.pattern].concat(args.rest)
      <span class="hljs-keyword">return</span> self.add.apply(fix,addargs)
    }
    
    <span class="hljs-keyword">return</span> fix
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_delegate</span><span class="hljs-params">(fixedargs)</span> {</span>
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">var</span> delegate = <span class="hljs-built_in">Object</span>.create(self)
    <span class="hljs-keyword">var</span> act = self.act

    delegate.act = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">var</span> argscb = handle_act_args(<span class="hljs-keyword">this</span>,arr(<span class="hljs-built_in">arguments</span>))</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>can’t override fixedargs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> args = _.extend({},argscb[<span class="hljs-number">0</span>],fixedargs)

      <span class="hljs-keyword">var</span> cb = argscb[<span class="hljs-number">1</span>]

      act.call(<span class="hljs-keyword">this</span>,args,cb)

      <span class="hljs-keyword">return</span> delegate
    }

    <span class="hljs-keyword">var</span> strdesc
    delegate.toString = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">if</span>( strdesc ) <span class="hljs-keyword">return</span> strdesc;
      <span class="hljs-keyword">var</span> vfa = {}
      _.each(fixedargs,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v,k)</span> {</span>
        <span class="hljs-keyword">if</span>( ~k.indexOf(<span class="hljs-string">'$'</span>) ) <span class="hljs-keyword">return</span>;
        vfa[k]=v
      })

      strdesc = self.toString()+(_.keys(vfa).length?<span class="hljs-string">'/'</span>+common.owndesc(vfa,<span class="hljs-number">0</span>,<span class="hljs-literal">false</span>):<span class="hljs-string">''</span>)

      <span class="hljs-keyword">return</span> strdesc
    }
    
    delegate.delegate = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(further_fixedargs)</span> {</span>
      <span class="hljs-keyword">var</span> args = _.extend({},further_fixedargs||{},fixedargs)
      <span class="hljs-keyword">return</span> self.delegate.call(<span class="hljs-keyword">this</span>,args)
    }

    delegate.fixedargs = fixedargs</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Somewhere to put contextual data for this delegate.
For example, data for individual web requests.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    delegate.context = {}

    <span class="hljs-keyword">return</span> delegate
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_options</span><span class="hljs-params">( options )</span> {</span>
    so = $.exports.options = (<span class="hljs-literal">null</span> == options) ? optioner.get() : optioner.set( options );

    <span class="hljs-keyword">if</span>( options &amp;&amp; options.log ) {
      $.logrouter = logging.makelogrouter(so.log)
      self.log = logging.makelog($.logrouter,self.id)
    }

    <span class="hljs-keyword">return</span> so
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>DEPRECATED 
for use with async</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  self.next_act = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> si   = <span class="hljs-keyword">this</span> || self
    <span class="hljs-keyword">var</span> args = arr(<span class="hljs-built_in">arguments</span>)
    
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(next)</span> {</span>
      args.push(next)
      si.act.apply(si,args)
    }
  }


  <span class="hljs-keyword">return</span> self
}</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>Utilities</p>

            </div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>Error arguments:
code
code, values
code, Error, values
Error (optional code,message properties), values
values (optional code,message properties)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle_error_args</span><span class="hljs-params">( args, ctxt )</span> {</span>
  args = arr(args)

  <span class="hljs-keyword">var</span> first = args[<span class="hljs-number">0</span>]
  <span class="hljs-keyword">var</span> valstart = <span class="hljs-number">1</span>

  <span class="hljs-keyword">var</span> code = <span class="hljs-string">'unknown'</span>
  code = _.isString(first) ? first : code 
  code = util.isError(first) &amp;&amp; _.isString(first.code) ? first.code : code
  code = _.isObject(first) &amp;&amp; _.isString(first.code) ? first.code : code 


  <span class="hljs-keyword">if</span>( _.isObject(first) &amp;&amp; !util.isError(first) ) {
    valstart = <span class="hljs-number">0</span>
  }

  <span class="hljs-keyword">var</span> error = util.isError(first) ? first : util.isError(args[<span class="hljs-number">1</span>]) ? (valstart=<span class="hljs-number">2</span>,args[<span class="hljs-number">1</span>]) : <span class="hljs-literal">null</span>

  <span class="hljs-keyword">var</span> valmap = _.isObject(args[valstart]) ? args[valstart] : {}

  <span class="hljs-keyword">var</span> message = (MSGMAP[ctxt.plugin] &amp;&amp; MSGMAP[ctxt.plugin][code])
  message = _.isString(message) ? message : (_.isString(valmap.message) &amp;&amp; valmap.message)
  message = _.isString(message) ? message : (error &amp;&amp; _.isString(error.message) &amp;&amp; error.message)
  message = _.isString(message) ? message : code</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>workaround to prevent underscore blowing up if properties are not found
reserved words and undefined need to be suffixed with $ in the template interpolates</p>

            </div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>TODO: use eraro</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-keyword">var</span> valstrmap = {}
  _.each(valmap,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(val,key)</span> {</span>
    <span class="hljs-comment">/* jshint evil:true */</span>
    <span class="hljs-keyword">try</span> { <span class="hljs-built_in">eval</span>(<span class="hljs-string">'var '</span>+key+<span class="hljs-string">';'</span>) } <span class="hljs-keyword">catch</span>(e) { key = key+<span class="hljs-string">'$'</span> }
    <span class="hljs-keyword">if</span>( {<span class="hljs-string">'undefined'</span>:<span class="hljs-number">1</span>,<span class="hljs-string">'NaN'</span>:<span class="hljs-number">1</span>}[key] ) { key = key+<span class="hljs-string">'$'</span> }
    valstrmap[key] = (_.isObject(val) ? common.owndesc(val,<span class="hljs-number">1</span>) : <span class="hljs-string">''</span>+val)
  })

  <span class="hljs-keyword">var</span> done = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">while</span>( !done ) {
    <span class="hljs-keyword">try</span> {
      message = _.template( message, valstrmap )
      done = <span class="hljs-literal">true</span>
    }
    <span class="hljs-keyword">catch</span>(e) {
      <span class="hljs-keyword">if</span>(e <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">ReferenceError</span>) {
        <span class="hljs-keyword">var</span> m = <span class="hljs-regexp">/ReferenceError:\s+(.*?)\s+/</span>.exec(e.toString())
        <span class="hljs-keyword">if</span>( m &amp;&amp; m[<span class="hljs-number">1</span>] ) {
          valstrmap[m[<span class="hljs-number">1</span>]]=<span class="hljs-string">"["</span>+m[<span class="hljs-number">1</span>]+<span class="hljs-string">"?]"</span>
        }
        <span class="hljs-keyword">else</span> done = <span class="hljs-literal">true</span>
      }
      <span class="hljs-keyword">else</span> {
        done = <span class="hljs-literal">true</span>
        message = message+<span class="hljs-string">' VALUES:'</span>+common.owndesc(valmap,<span class="hljs-number">2</span>)
      }
    }
  }

  <span class="hljs-keyword">return</span> {
    code:      code,
    error:     error,
    message:   message,
    remaining: args.slice(valstart),
    valmap:    valmap,
    callback:  _.isFunction(args[valstart]) ? args[valstart] : <span class="hljs-literal">null</span>
  }
}



<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">makedie</span><span class="hljs-params">( instance, ctxt )</span> {</span>
  ctxt = _.extend(ctxt,instance.die?instance.die.context:{})

  <span class="hljs-keyword">var</span> die = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> args = handle_error_args(<span class="hljs-built_in">arguments</span>,ctxt)

    <span class="hljs-keyword">var</span> code    = args.code
    <span class="hljs-keyword">var</span> error   = args.error
    <span class="hljs-keyword">var</span> message = args.message

    <span class="hljs-keyword">var</span> so = instance.options()</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>stayalive is only for testing, do not use in production</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> stayalive = so.test.stayalive || (error &amp;&amp; error.stayalive)

    <span class="hljs-keyword">if</span>( !error ) {
      error = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(code)
    }

    <span class="hljs-keyword">var</span> logargs  = [ctxt.type, ctxt.plugin, ctxt.tag, ctxt.id, code]
          .concat( message &amp;&amp; message != code ? message : <span class="hljs-keyword">void</span> <span class="hljs-number">0</span> )
          .concat( args.remaining )

    instance.log.fatal.apply( instance, logargs )

    <span class="hljs-keyword">var</span> stack = error.stack
    stack = stack.replace(<span class="hljs-regexp">/^.*?\n/</span>,<span class="hljs-string">'\n'</span>)

    <span class="hljs-keyword">var</span> procdesc = process.pid <span class="hljs-comment">// + more</span>

    <span class="hljs-keyword">var</span> stderrmsg =
          <span class="hljs-string">"\n\n"</span>+
          <span class="hljs-string">"Seneca Fatal Error\n"</span>+
          <span class="hljs-string">"==================\n\n"</span>+
          <span class="hljs-string">"Message: "</span>+message+<span class="hljs-string">"\n\n"</span>+
          <span class="hljs-string">"Code: "</span>+code+<span class="hljs-string">"\n\n"</span>+
          <span class="hljs-string">"Stack: "</span>+stack+<span class="hljs-string">"\n\n"</span>+
          <span class="hljs-string">"Instance: "</span>+instance.toString()+<span class="hljs-string">"\n\n"</span>+
          <span class="hljs-string">"When: "</span>+<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString()+<span class="hljs-string">"\n\n"</span>+
          <span class="hljs-string">"Log: "</span>+common.owndesc(logargs,<span class="hljs-number">3</span>)+<span class="hljs-string">"\n\n"</span>+
          <span class="hljs-string">"Node: "</span>+util.inspect(process.versions).replace(<span class="hljs-regexp">/\s+/g</span>,<span class="hljs-string">' '</span>)+<span class="hljs-string">"\n\n"</span>+
          <span class="hljs-string">"Process: pid="</span>+procdesc+<span class="hljs-string">", path="</span>+process.execPath+<span class="hljs-string">", args="</span>+util.inspect(process.argv)+<span class="hljs-string">"\n\n"</span>

    <span class="hljs-keyword">if</span>( stayalive ) {
      error = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(stderrmsg)
      error.seneca = {
        code:code,
        when:<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
        valmap:args.valmap
      }
      <span class="hljs-keyword">throw</span> error
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>this blocks, but that’s ok, we want to be sure the error description is printed to STDERR</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>( !so.test.silent ) {
      console.error( stderrmsg )
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>terminate process, err (if defined) is from seneca.close</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">die</span><span class="hljs-params">( err )</span> {</span>
      <span class="hljs-keyword">if</span>( !stayalive ) {
        process.nextTick(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
          <span class="hljs-keyword">if</span>( err ) console.error( err );
          console.error(<span class="hljs-string">"Terminated at "</span>+(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString())+<span class="hljs-string">". See above for error report.\n\n"</span>)
          process.exit(<span class="hljs-number">1</span>)
        })
      }
    }

    instance.close( die )</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>make sure we close down within options.deathdelay seconds</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>( !stayalive ) {
      <span class="hljs-keyword">var</span> killtimer = setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        console.error(<span class="hljs-string">"Terminated (on timeout) at "</span>+(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString())+<span class="hljs-string">".\n\n"</span>)
        process.exit(<span class="hljs-number">2</span>);
      }, so.deathdelay);
      killtimer.unref();
    }
  }

  die.context = ctxt
  
  <span class="hljs-keyword">return</span> die
}



<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">makefail</span><span class="hljs-params">( instance, ctxt )</span> {</span>
  ctxt = _.extend(ctxt,instance.fail?instance.fail.context:{})

  <span class="hljs-keyword">var</span> fail = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> args = handle_error_args(<span class="hljs-built_in">arguments</span>,ctxt)

    <span class="hljs-keyword">var</span> code    = args.code
    <span class="hljs-keyword">var</span> error   = args.error
    <span class="hljs-keyword">var</span> message = args.message


    message = instance.toString()+<span class="hljs-string">': '</span>+message
    message = message.replace(<span class="hljs-regexp">/[\r\n]/g</span>,<span class="hljs-string">' '</span>)

    <span class="hljs-keyword">if</span>( error ) {
      error.message = message
    }
    <span class="hljs-keyword">else</span> {
      error = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(message)
    }

    error.seneca = {
      code:code,
      when:<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
      valmap:args.valmap
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>DEPRECATED</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>( _.isFunction( args.callback ) ) {
      args.callback.call( instance, error )
    }

    <span class="hljs-keyword">return</span> error;
  }

  fail.context = ctxt

  <span class="hljs-keyword">return</span> fail
}



<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">make_plugin_delegate</span><span class="hljs-params">( instance, plugin, derived )</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>adjust seneca api to be plugin specific</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> sd = instance.delegate({
    plugin$:{name:plugin.name,tag:plugin.tag},
    ungate$:<span class="hljs-literal">true</span>
  })


  sd.log = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(level)</span> {</span>
    <span class="hljs-keyword">var</span> args = arr(<span class="hljs-built_in">arguments</span>)

    args.splice(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-string">'plugin'</span>,plugin.name,derived.tag)
    instance.log.apply(instance,args)
  }
  logging.makelogfuncs(sd)


  sd.die  = makedie( sd, {type:<span class="hljs-string">'plugin'</span>,plugin:plugin.name} )
  sd.fail = makefail( sd, {type:<span class="hljs-string">'plugin'</span>,plugin:plugin.name} )


  sd.add = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> args = arr(<span class="hljs-built_in">arguments</span>)

    <span class="hljs-keyword">var</span> actmeta = args[args.length-<span class="hljs-number">1</span>]
    
    <span class="hljs-keyword">if</span>( _.isFunction(actmeta) ) {
      actmeta = {}
      args.push(actmeta)
    }

    actmeta.plugin_nameref  = derived.nameref
    actmeta.plugin_fullname = plugin.fullname
    actmeta.plugin_tag      = derived.tag
    actmeta.log             = sd.log

    <span class="hljs-keyword">return</span> instance.add.apply(sd,args)
  }


  sd.context.module = plugin.parent || module
  sd.context.name   = plugin.name
  sd.context.tag    = plugin.tag
  sd.context.full   = plugin.fullname


  <span class="hljs-keyword">return</span> sd;
}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">make_trace_act</span><span class="hljs-params">( opts )</span> {</span>
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>,<span class="hljs-number">0</span>)
    args.unshift(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString())

    <span class="hljs-keyword">if</span>( opts.stack ) {
      args.push(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'trace...'</span>).stack)
    }

    console.log(args.join(<span class="hljs-string">'\t'</span>))
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>Primary export function, creates a new Seneca instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span><span class="hljs-params">( seneca_options )</span> {</span>
  <span class="hljs-keyword">var</span> so = seneca_options || {}</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Create a private context.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> $ = {
    stats:{
      start:<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime(),
      act:{calls:<span class="hljs-number">0</span>,done:<span class="hljs-number">0</span>,fails:<span class="hljs-number">0</span>,cache:<span class="hljs-number">0</span>},
      actmap:{}
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>Create instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> seneca = make_seneca($,so)</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>Add builtin actions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  seneca.add( {role:<span class="hljs-string">'seneca'</span>,  stats:<span class="hljs-literal">true</span>},  action_seneca_stats )
  seneca.add( {role:<span class="hljs-string">'seneca'</span>,  ready:<span class="hljs-literal">true</span>},  action_seneca_ready )
  seneca.add( {role:<span class="hljs-string">'seneca'</span>,  cmd:<span class="hljs-string">'close'</span>}, action_seneca_close )
  seneca.add( {role:<span class="hljs-string">'options'</span>, cmd:<span class="hljs-string">'get'</span>},   action_options_get  )</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>Define builtin actions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">action_seneca_close</span><span class="hljs-params">(args,done)</span> {</span>
    seneca.emit(<span class="hljs-string">'close'</span>)
    done()
  }


  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">action_seneca_ready</span><span class="hljs-params">(args,done)</span> {</span>
    seneca.emit(<span class="hljs-string">'ready'</span>)
    done()
  }


  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">action_seneca_stats</span><span class="hljs-params">( args, done )</span> {</span>
    <span class="hljs-keyword">var</span> stats
    <span class="hljs-keyword">if</span>( args.pattern &amp;&amp; $.stats.actmap[args.pattern] ) {
      stats = $.stats.actmap[args.pattern]
      stats.time = $.timestats.calculate(args.pattern)
    }
    <span class="hljs-keyword">else</span> {
      stats = _.clone($.stats)
      stats.now    = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()
      stats.uptime = stats.now - stats.start

      stats.now   = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(stats.now).toISOString()
      stats.start = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(stats.start).toISOString()

      <span class="hljs-keyword">var</span> summary = (<span class="hljs-literal">null</span> == args.summary &amp;&amp; <span class="hljs-literal">false</span>) || (<span class="hljs-regexp">/^false$/i</span>.exec(args.summary) ? <span class="hljs-literal">false</span> : !!(args.summary) )
      <span class="hljs-keyword">if</span>( summary ) {
        stats.actmap = <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>
      }
      <span class="hljs-keyword">else</span> {
        _.each( $.stats.actmap, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a,p)</span> {</span> $.stats.actmap[p].time = $.timestats.calculate(p) })
      }
    }

    done(<span class="hljs-literal">null</span>,stats)
  }


  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">action_options_get</span><span class="hljs-params">( args, done )</span> {</span>
    <span class="hljs-keyword">var</span> options = $.optioner.get()
    
    <span class="hljs-keyword">var</span> base = args.base || <span class="hljs-literal">null</span>
    <span class="hljs-keyword">var</span> root = base ? (options[base]||{}) : options 
    <span class="hljs-keyword">var</span> val  = args.key ? root[args.key] : root

    done(<span class="hljs-literal">null</span>,common.copydata(val))
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>register default plugins</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  seneca.use(<span class="hljs-string">'util'</span>)
  seneca.use(<span class="hljs-string">'mem-store'</span>)
  seneca.use(<span class="hljs-string">'web'</span>)
  seneca.use(<span class="hljs-string">'transport'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>Register plugins specified in options.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.each(so.plugins, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(plugindesc)</span> {</span>
    seneca.use(plugindesc)
  })</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>Create entity delegate.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> sd = seneca.delegate()
  sd.log = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> args = [<span class="hljs-string">'entity'</span>]
    seneca.log.apply(seneca,args.concat(arr(<span class="hljs-built_in">arguments</span>)))
  }
  logging.makelogfuncs(sd)</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Template entity that makes all others.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $.entity = <span class="hljs-keyword">new</span> Entity({},sd)

  <span class="hljs-keyword">return</span> seneca
}</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>To reference builtin loggers when defining logging options.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>init.loghandler = logging.handlers</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>Makes require(‘seneca’).use( … ) work by creating an on-the-fly instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>init.use = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">var</span> instance = init()
  <span class="hljs-keyword">return</span> instance.use.apply(instance,arr(<span class="hljs-built_in">arguments</span>))
}</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>Mostly for testing.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span>( <span class="hljs-built_in">require</span>.main === module ) {
  init()
}</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>Error code messages.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> MSGMAP = {
  seneca:{
    test_msg: <span class="hljs-string">'Test message.'</span>,
    test_prop: <span class="hljs-string">'TESTING: exists: &lt;%=exists%&gt;, notfound:&lt;%=notfound%&gt;, str=&lt;%=str%&gt;, obj=&lt;%=obj%&gt;, arr=&lt;%=arr%&gt;, bool=&lt;%=bool%&gt;, null=&lt;%=null$%&gt;, delete=&lt;%=delete$%&gt;, undefined=&lt;%=undefined$%&gt;, void=&lt;%=void$%&gt;, NaN=&lt;%=NaN$%&gt;'</span>,

    add_string_pattern_syntax: <span class="hljs-string">'Could not add action due to syntax error in pattern string: "&lt;%=argstr%&gt;": Line:&lt;%=line%&gt;, Column:&lt;%=col%&gt;; &lt;%=syntax%&gt;'</span>,
    act_string_args_syntax: <span class="hljs-string">'Could execute action due to syntax error in argument string: "&lt;%=argstr%&gt;": Line:&lt;%=line%&gt;, Column:&lt;%=col%&gt;; &lt;%=syntax%&gt;'</span>,

    add_pattern_object_expected_after_string_pattern: <span class="hljs-string">'Could not add action; unexpected argument; a pattern object or function should follow the pattern string; arguments were: "&lt;%=args%&gt;".'</span>,
    add_pattern_object_expected: <span class="hljs-string">'Could not add action; unexpected argument; a pattern object or string should be the first argument; arguments were: "&lt;%=args%&gt;".'</span>,

    add_action_function_expected: <span class="hljs-string">'Could not add action: the action function should appear after the pattern; arguments were: "&lt;%=args%&gt;".'</span>,
    add_action_metadata_not_an_object: <span class="hljs-string">'Could not add action: the argument after the action function should be a metadata object: &lt;%=actmeta%&gt;.'</span>,

    add_empty_pattern: <span class="hljs-string">'Could not add action, as the action pattern is empty: "&lt;%=args%&gt;"'</span>,

    act_if_expects_boolean: <span class="hljs-string">'The method act_if expects a boolean value as its first argument, was: "&lt;%=first%&gt;".'</span>,

    act_not_found: <span class="hljs-string">'No matching action pattern found for "&lt;%=args%&gt;", and no default result provided (using a default$ property).'</span>,
    act_no_args: <span class="hljs-string">'No action pattern defined in "&lt;%=args%&gt;"; the first argument should be a string or object pattern.'</span>,
    act_invalid_args: <span class="hljs-string">'Invalid action arguments; &lt;%=message%&gt;; arguments were: "&lt;%=args%&gt;".'</span>
  }
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
